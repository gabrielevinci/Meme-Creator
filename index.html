<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; font-src 'self';">
    <title>Content Creator - 0 Chiacchiere</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }
        
        .container {
            max-width: 100vw;
            width: 100%;
            height: 100vh;
            margin: 0;
            background: white;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: #2c3e50;
            color: white;
            padding: 15px 20px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 1em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 20px;
            display: grid;
            /* Layout colonne: 1=AI, 2=Font/Banner, 3=Parametri Video, 4=Opzioni/Media, 5=Status/Video Lista */
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
            gap: 20px;
            flex: 1;
            overflow-y: auto;
        }
        /* Colonna 1: AI e Creativit√† */
        
        .left-panel,
        /* Colonna 2: Font e Margini */
        
        .middle-panel,
        /* Colonna 3: Parametri Video */
        
        .right-panel,
        /* Colonna 4: Opzioni e Media Avanzati */
        
        .fourth-panel,
        /* Colonna 5: Status e Video Lista */
        
        .fifth-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        .form-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 1.1em;
        }
        
        .input-field {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            resize: vertical;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .textarea-small {
            min-height: 80px;
            font-family: inherit;
        }
        
        .textarea-large {
            min-height: 200px;
            font-family: 'Courier New', monospace;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3498db;
        }
        
        .checkbox-group label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }
        /* Stili per i controlli range */
        
        .range-input {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            margin: 8px 0;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .range-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }
        
        .range-input::-webkit-slider-thumb:hover {
            background: #2980b9;
            transform: scale(1.1);
        }
        
        .range-input::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498db;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }
        
        .range-value {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
            cursor: pointer;
            min-width: 45px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .range-value:hover {
            background: #2980b9;
            transform: scale(1.05);
        }

        .range-value-editing {
            background: white !important;
            color: #2c3e50 !important;
            border: 2px solid #3498db !important;
            outline: none;
            box-sizing: border-box;
            display: inline-block;
            vertical-align: baseline;
        }

        /* Nasconde gli spinner (freccette su/gi√π) negli input numerici */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield; /* Firefox */
            appearance: textfield; /* Standard */
        }

        .range-input-group {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .range-number-input {
            width: 70px;
            padding: 4px 6px;
            border: 2px solid #3498db;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            background: white;
            color: #2c3e50;
        }

        .range-number-input:focus {
            outline: none;
            border-color: #2980b9;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        .range-unit {
            font-size: 12px;
            font-weight: 600;
            color: #3498db;
        }
        /* Stili per slider temperature */
        
        .slider-container {
            margin-top: 10px;
        }
        
        .slider-labels {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
            font-size: 12px;
        }
        
        .slider-label-left,
        .slider-label-right {
            color: #666;
            font-weight: 500;
        }
        
        .help-text {
            display: block;
            margin-top: 8px;
            font-size: 11px;
            color: #777;
            font-style: italic;
            line-height: 1.3;
        }
        /* Stili per i controlli margini */
        
        .margin-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        
        .margin-item {
            display: flex;
            flex-direction: column;
        }
        
        .margin-item label {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            color: #555;
        }
        /* Stili per il Preview Dashboard - AGGIORNATO */
        
        .banner-preview-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 10px;
        }
        
        .video-frame {
            background: #2c3e50;
            border-radius: 8px;
            overflow: hidden;
            width: 320px;
            height: 240px;
            position: relative;
            margin: 0 auto;
            border: 2px solid #34495e;
        }
        
        .banner-preview {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #3498db;
            position: absolute;
            width: 100%;
            left: 0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .banner-preview#banner-top-preview {
            top: 0;
            border-bottom: 3px solid #e74c3c;
        }
        
        .banner-preview#banner-bottom-preview {
            bottom: 0;
            border-top: 3px solid #e74c3c;
        }
        
        .text-area-rect {
            position: absolute;
            border: 3px solid #e74c3c;
            background: rgba(231, 76, 60, 0.15);
            box-shadow: inset 0 0 10px rgba(231, 76, 60, 0.2);
            transition: all 0.3s ease;
            pointer-events: none;
        }
        
        .text-area-rect::before {
            content: 'AREA TESTO';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #c0392b;
            font-weight: bold;
            font-size: 12px;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
            white-space: nowrap;
        }
        
        .text-area-rect.full-banner::before {
            content: 'FULL BANNER';
            color: #27ae60;
        }
        
        .text-area-rect.full-banner {
            border-color: #27ae60;
            background: rgba(46, 204, 113, 0.15);
            box-shadow: inset 0 0 10px rgba(46, 204, 113, 0.2);
        }
        
        .video-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #95a5a6;
        }
        
        .video-placeholder {
            font-size: 16px;
            font-weight: 500;
        }
        
        .preview-info {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            font-size: 12px;
        }
        
        .info-item {
            background: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: 1px solid #e0e0e0;
            min-width: 200px;
            text-align: center;
        }
        
        .info-label {
            font-weight: 600;
            color: #555;
            margin-right: 8px;
        }
        
        .info-item span:last-child {
            color: #3498db;
            font-weight: 500;
        }
        
        .select-field {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .select-field:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        /* Stili per il select personalizzato dei font */
        
        .custom-select-container {
            position: relative;
        }
        
        .custom-select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 20px;
        }
        
        .custom-select:hover {
            border-color: #3498db;
        }
        
        .custom-select.open {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .select-display {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .select-arrow {
            margin-left: 10px;
            transition: transform 0.3s ease;
        }
        
        .custom-select.open .select-arrow {
            transform: rotate(180deg);
        }
        
        .select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #3498db;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .select-options.show {
            display: block;
        }
        
        .select-option {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s ease;
            font-size: 16px;
            font-weight: 500;
        }
        
        .select-option:hover {
            background-color: #f8f9fa;
        }
        
        .select-option:last-child {
            border-bottom: none;
        }
        
        .select-option.selected {
            background-color: #e8f4fd;
            color: #2c3e50;
        }
        /* Mantieni gli stili legacy per compatibilit√† */
        
        .font-select-option {
            font-size: 16px;
            padding: 8px 12px;
        }
        
        #font-select option {
            padding: 10px;
            font-size: 16px;
            font-weight: 500;
            line-height: 1.6;
            min-height: 24px;
            font-display: swap;
        }
        
        #font-select option:first-child {
            font-family: inherit !important;
            font-style: italic;
            color: #666;
        }
        /* Forza il caricamento dei font personalizzati */
        
        .font-preview {
            font-display: swap;
            font-variant-ligatures: none;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            flex: 2;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            flex: 1;
        }
        
        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(231, 76, 60, 0.3);
        }
        
        .btn-api {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            flex: 1;
        }
        
        .btn-api:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(155, 89, 182, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .status-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border-left: 5px solid #3498db;
        }
        
        .status-panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            width: 0%;
            transition: width 0.5s ease;
        }
        
        .video-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .video-item {
            padding: 5px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 14px;
        }
        
        .video-item:last-child {
            border-bottom: none;
        }
        
        .api-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .api-modal-content {
            background: white;
            border-radius: 15px;
            padding: 0;
            width: 95%;
            max-width: 1200px;
            max-height: 95vh;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: white;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .api-dashboard {
            padding: 30px;
            display: flex;
            gap: 30px;
            min-height: 600px;
        }
        
        .api-sidebar {
            flex: 0 0 300px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .api-main {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .api-list-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        
        .api-list-item:hover {
            border-color: #3498db;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .api-list-item.active {
            border-color: #27ae60;
            background: #f8fff8;
        }
        
        .api-list-item.disabled {
            opacity: 0.6;
            border-color: #e74c3c;
            background: #fff8f8;
        }
        
        .api-stats {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #f0f0f0;
        }
        
        .rpd-usage-bar {
            width: 100%;
            height: 4px;
            background-color: #e9ecef;
            border-radius: 2px;
            margin: 4px 0 2px 0;
            overflow: hidden;
        }
        
        .rpd-usage-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        .api-status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
        }
        
        .api-status-badge.disabled {
            background: #e74c3c;
        }
        
        .add-api-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.2s ease;
        }
        
        .add-api-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }
        
        .api-form {
            display: none;
        }
        
        .api-form.active {
            display: block;
        }
        
        .form-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .form-section h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 18px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: end;
        }
        
        .form-field {
            flex: 1;
        }
        
        .form-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .form-field input,
        .form-field select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }
        
        .form-field input:focus,
        .form-field select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .model-item {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            position: relative;
        }
        
        .model-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .model-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .model-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-small {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .btn-edit {
            background: #3498db;
            color: white;
        }
        
        .btn-delete {
            background: #e74c3c;
            color: white;
        }
        
        .btn-small:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .limits-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .limit-item input {
            border: 1px solid transparent;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .limit-item input:hover {
            border-color: #ddd;
            background: #f9f9f9;
        }
        
        .limit-item input:focus {
            border-color: #3498db;
            background: white;
            outline: none;
        }
        
        .model-name input {
            border: 1px solid transparent;
            padding: 2px 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .model-name input:hover {
            border-color: #ddd;
            background: #f9f9f9;
        }
        
        .model-name input:focus {
            border-color: #3498db;
            background: white;
            outline: none;
        }
        
        .model-name select {
            border: 1px solid transparent;
            padding: 2px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }
        
        .model-name select:hover {
            border-color: #ddd;
            background: #f9f9f9;
        }
        
        .model-name select:focus {
            border-color: #3498db;
            background: white;
            outline: none;
        }
        
        .limit-item {
            text-align: center;
            background: #f0f9ff;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #3498db;
        }
        
        .limit-value {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .limit-label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
            transition: all 0.2s ease;
        }
        
        .save-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }
        
        .cancel-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .cancel-btn:hover {
            background: #7f8c8d;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked+.toggle-slider {
            background-color: #27ae60;
        }
        
        input:checked+.toggle-slider:before {
            transform: translateX(26px);
        }
        /* Stili per il modal delle API */
        
        .api-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        
        .api-modal-content {
            background-color: white;
            margin: 2% auto;
            border-radius: 15px;
            width: 95%;
            max-width: 1200px;
            height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 24px;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s ease;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .api-dashboard {
            display: flex;
            height: calc(90vh - 80px);
        }
        
        .api-sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 2px solid #e0e0e0;
            overflow-y: auto;
            padding: 20px;
        }
        
        .add-api-btn {
            width: 100%;
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }
        
        .add-api-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(46, 204, 113, 0.3);
        }
        
        .api-list-item {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            padding-left: 25px;
        }
        
        .api-list-item:hover {
            border-color: #9b59b6;
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.2);
        }
        
        .api-list-item.active {
            border-color: #27ae60;
            background: #f8fff8;
        }
        
        .api-list-item.disabled {
            opacity: 0.6;
            border-color: #e74c3c;
            background: #fff5f5;
        }
        
        .api-status-badge {
            position: absolute;
            left: 8px;
            top: 18px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #27ae60;
        }
        
        .api-status-badge.disabled {
            background: #e74c3c;
        }
        
        .api-main {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 22px;
        }
        
        .api-form {
            display: none;
        }
        
        .api-form.active {
            display: block;
        }
        
        .form-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid #e0e0e0;
        }
        
        .form-section h3 {
            margin: 0 0 20px 0;
            color: #2c3e50;
            font-size: 18px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-field {
            display: flex;
            flex-direction: column;
        }
        
        .form-field label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .form-field input,
        .form-field select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-field input:focus,
        .form-field select:focus {
            outline: none;
            border-color: #9b59b6;
            box-shadow: 0 0 0 3px rgba(155, 89, 182, 0.1);
        }
        
        .save-btn {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(46, 204, 113, 0.3);
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.3s ease;
        }
        
        .cancel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(231, 76, 60, 0.3);
        }
        
        .btn-small {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-edit {
            background: #3498db;
            color: white;
        }
        
        .btn-edit:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .btn-delete {
            background: #e74c3c;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }
        /* Stili per controlli checkbox e nested */
        
        .checkbox-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .checkbox-input {
            margin-right: 10px;
            transform: scale(1.2);
        }
        
        .checkbox-label {
            font-weight: 600;
            color: #2c3e50;
            cursor: pointer;
            user-select: none;
        }
        
        .nested-controls {
            margin-left: 30px;
            padding-left: 15px;
            border-left: 3px solid #3498db;
            background: rgba(52, 152, 219, 0.05);
            border-radius: 0 8px 8px 0;
            padding-top: 15px;
            padding-bottom: 10px;
            padding-right: 15px;
            margin-top: 10px;
        }
        
        .secondary-button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        .secondary-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(52, 152, 219, 0.3);
        }
        
        .secondary-button:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            color: #555;
            font-style: italic;
            min-height: 20px;
        }
        
        .file-info:empty::before {
            content: "Nessun file selezionato";
            color: #999;
        }
        /* Animazioni per notifiche */
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @media (max-width: 1024px) {
            .main-content {
                display: flex;
                flex-direction: column;
                gap: 20px;
            }
            .left-panel,
            .middle-panel,
            .right-panel {
                display: contents;
                /* Questo fa s√¨ che i figli vengano trattati come se fossero direttamente nel parent */
            }
            .left-panel>*,
            .middle-panel>*,
            .right-panel>* {
                margin-bottom: 20px;
            }
            /* Ordine specifico per layout a colonna singola */
            .tipologia-meme {
                order: 1;
            }
            .filtro-video {
                order: 2;
            }
            .stile-meme {
                order: 3;
            }
            .font-section {
                order: 4;
            }
            .text-formatting {
                order: 5;
            }
            .video-input {
                order: 6;
            }
            .output-folder-option {
                order: 6.5;
            }
            .button-group {
                order: 7;
            }
            .status-panel {
                order: 8;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            .header h1 {
                font-size: 2em;
            }
            .main-content {
                padding: 20px;
            }
            .button-group {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üé¨ Content Creator</h1>
            <p>0 Chiacchiere - Generatore di Meme AI</p>
        </div>

        <div class="main-content">
            <div class="left-panel">
                <div class="form-group tipologia-meme">
                    <label for="meme-type">üìù Tipologia Meme</label>
                    <textarea id="meme-type" class="input-field textarea-small" placeholder="Descrivi il tipo di meme che vuoi creare..." rows="3"></textarea>
                </div>

                <div class="form-group filtro-video">
                    <label for="video-filter">üéØ Filtro Video</label>
                    <textarea id="video-filter" class="input-field textarea-small" placeholder="Specifica criteri per filtrare i contenuti video..." rows="3"></textarea>
                    <div class="checkbox-group">
                        <input type="checkbox" id="collage-mode">
                        <label for="collage-mode">üñºÔ∏è Rilevamento con collage</label>
                    </div>
                </div>

                <div class="form-group stile-meme">
                    <label for="meme-style">‚ú® Stile Meme</label>
                    <textarea id="meme-style" class="input-field textarea-large" placeholder="Inserisci esempi dettagliati dello stile di meme desiderato..." rows="15"></textarea>
                </div>

                <div class="form-group">
                    <label for="temperature-slider">üé≤ Creativit√† AI (Temperature)</label>
                    <div class="slider-container">
                        <input type="range" id="temperature-slider" class="range-input" min="0" max="2" value="1" step="0.01">
                        <div class="slider-labels">
                            <span class="slider-label-left">0 (Preciso)</span>
                            <div class="range-input-group">
                                <input type="number" id="temperature-input" class="range-number-input" min="0" max="2" step="0.01" value="1.00">
                                <span class="range-unit"></span>
                            </div>
                            <span class="slider-label-right">2 (Creativo)</span>
                        </div>
                    </div>
                    <small class="help-text">Controlla la casualit√† delle risposte AI: valori bassi = pi√π prevedibile, valori alti = pi√π creativo</small>
                </div>
            </div>

            <!-- NUOVA COLONNA CENTRALE: Controlli Video -->
            <div class="middle-panel">
                <div class="form-group font-section">
                    <label for="font-select">üé® Font</label>
                    <div class="custom-select-container">
                        <div id="font-select" class="custom-select">
                            <span class="select-display">Caricamento font...</span>
                            <span class="select-arrow">‚ñº</span>
                        </div>
                        <div id="font-options" class="select-options">
                            <!-- Options will be populated here -->
                        </div>
                    </div>
                    <input type="hidden" id="selected-font" value="">
                </div>

                <div class="form-group text-formatting">
                    <label for="text-format">üìù Formato Testo Meme</label>
                    <select id="text-format" class="select-field">
                        <option value="normal">Mantieni formato originale</option>
                        <option value="uppercase">TUTTO MAIUSCOLO</option>
                        <option value="lowercase">tutto minuscolo</option>
                        <option value="capitalize">Prima Lettera Maiuscola</option>
                        <option value="title">Ogni Prima Lettera Maiuscola</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="block-height">üìê Altezza Blocco Bianco</label>
                    <div class="slider-container">
                        <input type="range" id="block-height" class="range-input" min="200" max="800" value="350" step="10">
                        <div class="slider-labels">
                            <span class="slider-label-left">200px</span>
                            <span id="block-height-value" class="slider-value">350px</span>
                            <span class="slider-label-right">800px</span>
                        </div>
                    </div>
                    <div class="help-text">
                        <small>üí° Controlla l'altezza del banner bianco. Il valore viene scalato proporzionalmente in base alle dimensioni del video.</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>üìè Margini Testo</label>
                    <div class="margin-controls">
                        <div class="margin-item">
                            <label for="margin-top">‚Üë Alto</label>
                            <input type="range" id="margin-top" class="range-input" min="0" max="100" value="30" step="1">
                            <span id="margin-top-value" class="range-value">30px</span>
                        </div>
                        <div class="margin-item">
                            <label for="margin-bottom">‚Üì Basso</label>
                            <input type="range" id="margin-bottom" class="range-input" min="0" max="100" value="30" step="1">
                            <span id="margin-bottom-value" class="range-value">30px</span>
                        </div>
                        <div class="margin-item">
                            <label for="margin-left">‚Üê Sinistra</label>
                            <input type="range" id="margin-left" class="range-input" min="0" max="150" value="40" step="1">
                            <span id="margin-left-value" class="range-value">40px</span>
                        </div>
                        <div class="margin-item">
                            <label for="margin-right">‚Üí Destra</label>
                            <input type="range" id="margin-right" class="range-input" min="0" max="150" value="40" step="1">
                            <span id="margin-right-value" class="range-value">40px</span>
                        </div>
                    </div>
                </div>

                <!-- PREVIEW DASHBOARD VISIVO - AGGIORNATO -->
                <div class="form-group">
                    <div class="banner-preview-container">
                        <div class="video-frame">
                            <!-- Banner TOP con area testo dinamica -->
                            <div class="banner-preview" id="banner-top-preview">
                                <div class="text-area-rect" id="text-area-top"></div>
                            </div>

                            <!-- Spazio video al centro -->
                            <div class="video-content" style="flex: 1; display: flex; align-items: center; justify-content: center; color: #ecf0f1; font-size: 14px;">
                                üìπ Video Content
                            </div>

                            <!-- Banner BOTTOM con area testo dinamica -->
                            <div class="banner-preview" id="banner-bottom-preview">
                                <div class="text-area-rect" id="text-area-bottom"></div>
                            </div>
                        </div>
                        <div class="preview-info">
                            <div class="info-item">
                                <span class="info-label">Area Testo:</span>
                                <span id="text-area-display">Calcolando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">
                <div class="form-group">
                    <h3 style="color: #2c3e50; margin-bottom: 15px; font-size: 1.2em; text-align: center;">üé¨ Parametri Video</h3>
                </div>

                <div class="form-group">
                    <label for="video-speed-slider">‚ö° Velocit√† Video</label>
                    <div class="slider-container">
                        <input type="range" id="video-speed-slider" class="range-input" min="0.1" max="10" value="1" step="0.01">
                        <div class="slider-labels">
                            <span class="slider-label-left">0.1x (Lento)</span>
                            <span id="video-speed-value" class="range-value">1.00x</span>
                            <span class="slider-label-right">10x (Veloce)</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="video-zoom-slider">üîç Zoom Video</label>
                    <div class="slider-container">
                        <input type="range" id="video-zoom-slider" class="range-input" min="0" max="2" value="1" step="0.01">
                        <div class="slider-labels">
                            <span class="slider-label-left">0x</span>
                            <span id="video-zoom-value" class="range-value">1.00x</span>
                            <span class="slider-label-right">2x</span>
                        </div>
                    </div>
                </div>

                <!-- Contrasto -->
                <div class="form-group">
                    <label for="contrast-slider">üé® Contrasto</label>
                    <div class="slider-container">
                        <input type="range" id="contrast-slider" class="range-input" min="0" max="2" value="1" step="0.01">
                        <div class="slider-labels">
                            <span class="slider-label-left">0 (Min)</span>
                            <span id="contrast-value" class="range-value">1.00</span>
                            <span class="slider-label-right">2 (Max)</span>
                        </div>
                    </div>
                </div>

                <!-- Saturazione -->
                <div class="form-group">
                    <label for="saturation-slider">üåà Saturazione</label>
                    <div class="slider-container">
                        <input type="range" id="saturation-slider" class="range-input" min="0" max="100" value="50" step="0.01">
                        <div class="slider-labels">
                            <span class="slider-label-left">0 (B/N)</span>
                            <span id="saturation-value" class="range-value">50.00</span>
                            <span class="slider-label-right">100 (Max)</span>
                        </div>
                    </div>
                </div>

                <!-- Gamma -->
                <div class="form-group">
                    <label for="gamma-slider">üîÜ Gamma</label>
                    <div class="slider-container">
                        <input type="range" id="gamma-slider" class="range-input" min="-1" max="1" value="0" step="0.01">
                        <div class="slider-labels">
                            <span class="slider-label-left">-1 (Scuro)</span>
                            <span id="gamma-value" class="range-value">0.00</span>
                            <span class="slider-label-right">+1 (Chiaro)</span>
                        </div>
                    </div>
                </div>

                <!-- Lift -->
                <div class="form-group">
                    <label for="lift-slider">üåÖ Lift</label>
                    <div class="slider-container">
                        <input type="range" id="lift-slider" class="range-input" min="-1" max="1" value="0" step="0.01">
                        <div class="slider-labels">
                            <span class="slider-label-left">-1 (Scuro)</span>
                            <span id="lift-value" class="range-value">0.00</span>
                            <span class="slider-label-right">+1 (Chiaro)</span>
                        </div>
                    </div>
                </div>

                <!-- Aumenta volume video -->
                <div class="form-group">
                    <label for="video-volume-slider">üîä Volume Video</label>
                    <div class="slider-container">
                        <input type="range" id="video-volume-slider" class="range-input" min="-100" max="30" value="0" step="1">
                        <div class="slider-labels">
                            <span class="slider-label-left">-100db (Muto)</span>
                            <span id="video-volume-value" class="range-value">0db</span>
                            <span class="slider-label-right">+30db (Max)</span>
                        </div>
                    </div>
                </div>

                <!-- Spazio per futuri parametri video -->
            </div>

            <!-- QUARTA COLONNA: Opzioni e Media Avanzati -->
            <div class="fourth-panel">
                <!-- Blocco Opzioni -->
                <div class="form-group">
                    <div class="options-container" style="background: #f8f9fa; border-radius: 12px; padding: 20px; border: 1px solid #e0e0e0;">
                        <h4 style="color: #2c3e50; margin: 0 0 15px 0; font-size: 1.1em; text-align: center; border-bottom: 2px solid #3498db; padding-bottom: 8px;">‚öôÔ∏è Opzioni</h4>

                        <!-- Rimuovi frame nero iniziale -->
                        <div class="form-group" style="margin-bottom: 15px;">
                            <div class="checkbox-container">
                                <input type="checkbox" id="remove-black-frame-enabled" class="checkbox-input">
                                <label for="remove-black-frame-enabled" class="checkbox-label">üéûÔ∏è Rimuovi Frame Nero Iniziale</label>
                            </div>
                        </div>

                        <!-- Aggiungi metadati -->
                        <div class="form-group" style="margin-bottom: 15px;">
                            <div class="checkbox-container">
                                <input type="checkbox" id="add-metadata-enabled" class="checkbox-input">
                                <label for="add-metadata-enabled" class="checkbox-label">üìã Aggiungi Metadati</label>
                            </div>
                        </div>

                        <!-- Elimina metadati -->
                        <div class="form-group" style="margin-bottom: 15px;">
                            <div class="checkbox-container">
                                <input type="checkbox" id="remove-metadata-enabled" class="checkbox-input">
                                <label for="remove-metadata-enabled" class="checkbox-label">üóëÔ∏è Elimina Metadati</label>
                            </div>
                            <div id="metadata-conflict-warning" class="help-text" style="margin-top: 8px; color: #e74c3c; display: none; font-weight: 600;">
                                ‚ö†Ô∏è Non puoi abilitare contemporaneamente "Aggiungi Metadati" e "Elimina Metadati"
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Blocco Media Avanzati -->
                <div class="form-group">
                    <div class="media-advanced-container" style="background: #f8f9fa; border-radius: 12px; padding: 20px; border: 1px solid #e0e0e0;">
                        <h4 style="color: #2c3e50; margin: 0 0 15px 0; font-size: 1.1em; text-align: center; border-bottom: 2px solid #3498db; padding-bottom: 8px;">üé¨ Media Avanzati</h4>

                        <!-- Sovrapponi immagine -->
                        <div class="form-group" style="margin-bottom: 20px;">
                            <div class="checkbox-container">
                                <input type="checkbox" id="overlay-image-enabled" class="checkbox-input">
                                <label for="overlay-image-enabled" class="checkbox-label">üñºÔ∏è Sovrapponi Immagine</label>
                            </div>
                            <div id="overlay-image-controls" class="nested-controls" style="display: none;">
                                <div class="form-group">
                                    <button type="button" id="overlay-image-select" class="secondary-button" disabled>
                                        üìÅ Seleziona Immagine
                                    </button>
                                    <div id="overlay-image-filename" class="file-info"></div>
                                </div>
                                <div class="form-group">
                                    <label for="overlay-opacity-slider">Opacit√† Sovrapposizione</label>
                                    <div class="slider-container">
                                        <input type="range" id="overlay-opacity-slider" class="range-input" min="0" max="100" value="50" step="1" disabled>
                                        <div class="slider-labels">
                                            <span class="slider-label-left">0%</span>
                                            <span id="overlay-opacity-value" class="range-value">50%</span>
                                            <span class="slider-label-right">100%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sostituisci suono -->
                        <div class="form-group" style="margin-bottom: 20px;">
                            <div class="checkbox-container">
                                <input type="checkbox" id="replace-audio-enabled" class="checkbox-input">
                                <label for="replace-audio-enabled" class="checkbox-label">üîÑ Sostituisci Suono</label>
                            </div>
                            <div id="replace-audio-controls" class="nested-controls" style="display: none;">
                                <div class="form-group">
                                    <button type="button" id="replace-audio-folder-select" class="secondary-button" disabled>
                                        üìÅ Seleziona Cartella Audio
                                    </button>
                                    <div id="replace-audio-folder-info" class="file-info"></div>
                                </div>
                                <div class="form-group">
                                    <div id="replace-audio-status" class="status-info" style="font-size: 0.9em; color: #666; margin-top: 5px;"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Audio di sottofondo -->
                        <div class="form-group" style="margin-bottom: 0;">
                            <div class="checkbox-container">
                                <input type="checkbox" id="background-audio-enabled" class="checkbox-input">
                                <label for="background-audio-enabled" class="checkbox-label">üéµ Audio di Sottofondo</label>
                            </div>
                            <div id="background-audio-controls" class="nested-controls" style="display: none;">
                                <div class="form-group">
                                    <button type="button" id="background-audio-select" class="secondary-button" disabled>
                                        üìÅ Seleziona Audio
                                    </button>
                                    <div id="background-audio-filename" class="file-info"></div>
                                </div>
                                <div class="form-group">
                                    <label for="background-audio-volume-slider">Volume Audio di Sottofondo</label>
                                    <div class="slider-container">
                                        <input type="range" id="background-audio-volume-slider" class="range-input" min="-100" max="30" value="0" step="1" disabled>
                                        <div class="slider-labels">
                                            <span class="slider-label-left">-100db (Muto)</span>
                                            <span id="background-audio-volume-value" class="range-value">0db</span>
                                            <span class="slider-label-right">+30db (Max)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- QUINTA COLONNA: Video Input e Status -->
            <div class="fifth-panel">
                <div class="form-group video-input">
                    <label>üìπ Video nella cartella INPUT</label>
                    <div class="status-item" style="margin: 8px 0; font-size: 14px; color: #666;">
                        <span>Totale video:</span>
                        <span id="video-count">0</span>
                    </div>
                    <div id="video-list" class="video-list">
                        <div class="video-item">Caricamento...</div>
                    </div>
                </div>

                <div class="button-group">
                    <button id="start-btn" class="btn btn-primary">üöÄ START</button>
                    <button id="stop-btn" class="btn btn-secondary" disabled>‚èπÔ∏è STOP</button>
                    <button id="api-btn" class="btn btn-api">‚öôÔ∏è API</button>
                </div>

                <div class="status-panel">
                    <h3>üìä Status Elaborazione</h3>
                    <div class="status-item">
                        <span>Fase corrente:</span>
                        <span id="current-phase">In attesa</span>
                    </div>
                    <div class="progress-bar">
                        <div id="progress-fill" class="progress-fill"></div>
                    </div>
                    <div id="progress-text" style="text-align: center; margin-top: 10px; font-size: 14px;">
                        Pronto per l'elaborazione
                    </div>
                </div>

                <!-- Opzione per aprire cartella OUTPUT -->
                <div class="form-group output-folder-option">
                    <div class="checkbox-group">
                        <input type="checkbox" id="open-output-folder" checked>
                        <label for="open-output-folder">üìÇ Apri cartella OUTPUT al termine del processo</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal per gestione API -->
    <div id="api-modal" class="api-modal">
        <div class="api-modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Gestione API & Modelli</h2>
                <button class="modal-close">&times;</button>
            </div>

            <div class="api-dashboard">
                <!-- Sidebar con lista API -->
                <div class="api-sidebar">
                    <button class="add-api-btn" onclick="ui.showNewApiForm()">
                        ‚ûï Aggiungi Nuova API
                    </button>

                    <div id="api-list">
                        <!-- Le API saranno caricate qui -->
                    </div>
                </div>

                <!-- Area principale di editing -->
                <div class="api-main">
                    <div id="api-welcome" class="empty-state">
                        <h3>üîå Gestione API</h3>
                        <p>Seleziona un'API dalla lista a sinistra per modificarla<br> oppure aggiungi una nuova API per iniziare.</p>
                    </div>

                    <!-- Form per nuova API -->
                    <div id="new-api-form" class="api-form">
                        <div class="form-section">
                            <h3>üìù Nuova API</h3>
                            <div class="form-row">
                                <div class="form-field">
                                    <label>ID API</label>
                                    <input type="text" id="new-api-id" placeholder="es: openai, anthropic, google">
                                </div>
                                <div class="form-field">
                                    <label>Nome Descrittivo</label>
                                    <input type="text" id="new-api-alias" placeholder="es: OpenAI Official">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-field">
                                    <label>Priorit√†</label>
                                    <select id="new-api-priority">
                                        <option value="1">1 - Massima priorit√†</option>
                                        <option value="2">2 - Molto alta</option>
                                        <option value="3">3 - Alta priorit√†</option>
                                        <option value="4">4 - Media-alta</option>
                                        <option value="5">5 - Media priorit√†</option>
                                        <option value="6">6 - Media-bassa</option>
                                        <option value="7">7 - Bassa priorit√†</option>
                                        <option value="8">8 - Molto bassa</option>
                                        <option value="9">9 - Minima priorit√†</option>
                                        <option value="10">10 - Backup/Fallback</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label>Stato</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="new-api-enabled" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div style="margin-top: 20px;">
                                <button class="save-btn" onclick="ui.saveNewApi()">üíæ Crea API</button>
                                <button class="cancel-btn" onclick="ui.cancelNewApi()">‚ùå Annulla</button>
                            </div>
                        </div>
                    </div>

                    <!-- Form per editing API esistente -->
                    <div id="edit-api-form" class="api-form">
                        <div class="form-section">
                            <h3 id="edit-api-title">‚úèÔ∏è Modifica API</h3>
                            <div class="form-row">
                                <div class="form-field">
                                    <label>ID API</label>
                                    <input type="text" id="edit-api-id" readonly style="background: #f5f5f5;">
                                </div>
                                <div class="form-field">
                                    <label>Nome Descrittivo</label>
                                    <input type="text" id="edit-api-alias" oninput="ui.autoSaveApiChanges()">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-field">
                                    <label>Priorit√†</label>
                                    <select id="edit-api-priority" onchange="ui.autoSaveApiChanges()">
                                        <option value="1">1 - Massima priorit√†</option>
                                        <option value="2">2 - Molto alta</option>
                                        <option value="3">3 - Alta priorit√†</option>
                                        <option value="4">4 - Media-alta</option>
                                        <option value="5">5 - Media priorit√†</option>
                                        <option value="6">6 - Media-bassa</option>
                                        <option value="7">7 - Bassa priorit√†</option>
                                        <option value="8">8 - Molto bassa</option>
                                        <option value="9">9 - Minima priorit√†</option>
                                        <option value="10">10 - Backup/Fallback</option>
                                    </select>
                                </div>
                                <div class="form-field">
                                    <label>Stato</label>
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="edit-api-enabled" onchange="ui.autoSaveApiChanges()">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Sezione modelli -->
                        <div class="form-section">
                            <h3>ü§ñ Modelli Configurati</h3>
                            <div id="models-list">
                                <!-- I modelli saranno caricati qui -->
                            </div>

                            <!-- Form per nuovo modello -->
                            <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px dashed #3498db;">
                                <h4 style="margin: 0 0 15px 0; color: #2c3e50;">‚ûï Aggiungi Nuovo Modello</h4>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>Nome Modello</label>
                                        <input type="text" id="new-model-name" placeholder="es: gpt-4o, claude-3">
                                    </div>
                                    <div class="form-field">
                                        <label>Priorit√† Modello</label>
                                        <select id="new-model-priority">
                                            <option value="1">1 - Primo uso</option>
                                            <option value="2">2 - Secondo uso</option>
                                            <option value="3">3 - Terzo uso</option>
                                            <option value="4">4 - Quarto uso</option>
                                            <option value="5">5 - Quinto uso</option>
                                            <option value="6">6 - Sesto uso</option>
                                            <option value="7">7 - Settimo uso</option>
                                            <option value="8">8 - Ottavo uso</option>
                                            <option value="9">9 - Nono uso</option>
                                            <option value="10">10 - Ultimo uso/Fallback</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>RPM (Richieste/Minuto)</label>
                                        <input type="number" id="new-model-rpm" value="100" min="1">
                                    </div>
                                    <div class="form-field">
                                        <label>RPD (Richieste/Giorno)</label>
                                        <input type="number" id="new-model-rpd" value="1000" min="1">
                                    </div>
                                    <div class="form-field">
                                        <label>TPM (Token/Minuto)</label>
                                        <input type="number" id="new-model-tpm" value="50000" min="1">
                                    </div>
                                </div>
                                <button class="save-btn" onclick="ui.addNewModel()" style="margin-top: 10px;">
                                    ‚ûï Aggiungi Modello
                                </button>
                            </div>
                        </div>

                        <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span style="color: #27ae60; font-size: 14px;">‚úÖ Auto-save attivo - Le modifiche vengono salvate automaticamente</span>
                                </div>
                                <div>
                                    <button class="btn-small btn-delete" onclick="ui.deleteCurrentApi()" style="padding: 12px 20px;">
                                        üóëÔ∏è Elimina API
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ContentCreatorUI {
            constructor() {
                this.isProcessing = false;
                this.apiConfig = null;
                // Variabili per i percorsi dei file
                this.overlayImagePath = '';
                this.backgroundAudioPath = '';
                this.replaceAudioFolderPath = '';

                this.initializeElements();
                this.setupEventListeners();
                this.loadInitialData();
            }

            initializeElements() {
                this.elements = {
                    memeType: document.getElementById('meme-type'),
                    videoFilter: document.getElementById('video-filter'),
                    collageMode: document.getElementById('collage-mode'),
                    fontSelect: document.getElementById('font-select'),
                    fontOptions: document.getElementById('font-options'),
                    selectedFont: document.getElementById('selected-font'),
                    textFormat: document.getElementById('text-format'),
                    memeStyle: document.getElementById('meme-style'),
                    startBtn: document.getElementById('start-btn'),
                    stopBtn: document.getElementById('stop-btn'),
                    apiBtn: document.getElementById('api-btn'),
                    videoCount: document.getElementById('video-count'),
                    currentPhase: document.getElementById('current-phase'),
                    progressFill: document.getElementById('progress-fill'),
                    progressText: document.getElementById('progress-text'),
                    videoList: document.getElementById('video-list'),
                    apiModal: document.getElementById('api-modal'),
                    apiContent: document.getElementById('api-content')
                };
            }

            setupEventListeners() {
                // Pulsanti principali
                this.elements.startBtn.addEventListener('click', () => this.startProcessing());
                this.elements.stopBtn.addEventListener('click', () => this.stopProcessing());
                this.elements.apiBtn.addEventListener('click', () => this.openApiManager());

                // Controlli dimensione font e margini
                this.setupRangeInputs();

                // Event listener per il text-format
                this.elements.textFormat.addEventListener('change', () => {
                    this.saveSettings();
                });

                // Custom font select
                this.elements.fontSelect.addEventListener('click', (e) => {
                    e.stopPropagation();
                    this.toggleFontDropdown();
                });

                // Chiudi dropdown quando si clicca fuori
                document.addEventListener('click', () => {
                    this.closeFontDropdown();
                });

                // Modal API
                this.elements.apiModal.addEventListener('click', (e) => {
                    if (e.target === this.elements.apiModal) {
                        this.closeApiManager();
                    }
                });

                document.querySelector('.modal-close').addEventListener('click', () => {
                    this.closeApiManager();
                });

                // Eventi IPC
                window.electronAPI.onStatusUpdate((event, data) => {
                    this.updateProcessingStatus(data);
                });

                window.electronAPI.onLogUpdate((event, data) => {
                    this.onProcessingComplete(data);
                });

                window.electronAPI.onProgressUpdate((event, error) => {
                    this.onProcessingError(error);
                });

                // Nuovi event listeners per errori API
                if (window.electronAPI.onDashboardError) {
                    window.electronAPI.onDashboardError((event, errorData) => {
                        this.handleDashboardError(errorData);
                    });
                }

                if (window.electronAPI.onApiError) {
                    window.electronAPI.onApiError((event, errorData) => {
                        this.handleApiError(errorData);
                    });
                }

                if (window.electronAPI.onProcessingError) {
                    window.electronAPI.onProcessingError((event, errorData) => {
                        this.handleProcessingError(errorData);
                    });
                }

                if (window.electronAPI.onAiAnalysisError) {
                    window.electronAPI.onAiAnalysisError((event, errorData) => {
                        this.handleAiAnalysisError(errorData);
                    });
                }

                // NUOVI: Event listeners per metadati video
                if (window.electronAPI.onVideoMetadataApplied) {
                    window.electronAPI.onVideoMetadataApplied((event, data) => {
                        this.handleVideoMetadataApplied(data);
                    });
                }

                if (window.electronAPI.onVideoMetadataError) {
                    window.electronAPI.onVideoMetadataError((event, data) => {
                        this.handleVideoMetadataError(data);
                    });
                }

                // Event listeners per i checkbox delle opzioni
                const removeBlackFrameCheckbox = document.getElementById('remove-black-frame-enabled');
                if (removeBlackFrameCheckbox) {
                    removeBlackFrameCheckbox.addEventListener('change', () => {
                        this.saveSettings();
                    });
                }

                const addMetadataCheckbox = document.getElementById('add-metadata-enabled');
                const removeMetadataCheckbox = document.getElementById('remove-metadata-enabled');
                const conflictWarning = document.getElementById('metadata-conflict-warning');

                if (addMetadataCheckbox) {
                    addMetadataCheckbox.addEventListener('change', () => {
                        // Se viene abilitato "Aggiungi Metadati", disabilita "Elimina Metadati"
                        if (addMetadataCheckbox.checked && removeMetadataCheckbox) {
                            removeMetadataCheckbox.checked = false;
                            this.hideMetadataConflictWarning();
                        }
                        this.saveSettings();
                    });
                }

                if (removeMetadataCheckbox) {
                    removeMetadataCheckbox.addEventListener('change', () => {
                        // Se viene abilitato "Elimina Metadati", disabilita "Aggiungi Metadati"
                        if (removeMetadataCheckbox.checked && addMetadataCheckbox) {
                            addMetadataCheckbox.checked = false;
                            this.hideMetadataConflictWarning();
                        } else if (!removeMetadataCheckbox.checked && addMetadataCheckbox && addMetadataCheckbox.checked) {
                            // Se entrambi sono selezionati dopo il deselect, mostra warning
                            this.showMetadataConflictWarning();
                        }
                        this.saveSettings();
                    });
                }

                // Controllo iniziale per conflitti
                if (addMetadataCheckbox && removeMetadataCheckbox) {
                    if (addMetadataCheckbox.checked && removeMetadataCheckbox.checked) {
                        // Priorit√† a "Elimina Metadati" se entrambi sono true
                        addMetadataCheckbox.checked = false;
                        this.showMetadataConflictWarning();
                    }
                }
            }

            // Funzione generale per rendere i valori degli slider editabili
            makeSliderValuesEditable() {
                const sliderMappings = [
                    // Slider esistenti
                    {sliderId: 'temperature-slider', valueId: 'temperature-input', min: 0, max: 2, step: 0.01, suffix: ''},
                    {sliderId: 'video-speed-slider', valueId: 'video-speed-value', min: 0.1, max: 10, step: 0.01, suffix: 'x'},
                    {sliderId: 'video-zoom-slider', valueId: 'video-zoom-value', min: 0, max: 2, step: 0.01, suffix: 'x'},
                    {sliderId: 'contrast-slider', valueId: 'contrast-value', min: 0, max: 2, step: 0.01, suffix: ''},
                    {sliderId: 'gamma-slider', valueId: 'gamma-value', min: -1, max: 1, step: 0.01, suffix: ''},
                    {sliderId: 'lift-slider', valueId: 'lift-value', min: -1, max: 1, step: 0.01, suffix: ''},
                    // Slider aggiuntivi
                    {sliderId: 'block-height', valueId: 'block-height-value', min: 200, max: 800, step: 1, suffix: 'px'},
                    {sliderId: 'margin-top', valueId: 'margin-top-value', min: 0, max: 100, step: 1, suffix: 'px'},
                    {sliderId: 'margin-bottom', valueId: 'margin-bottom-value', min: 0, max: 100, step: 1, suffix: 'px'},
                    {sliderId: 'margin-left', valueId: 'margin-left-value', min: 0, max: 150, step: 1, suffix: 'px'},
                    {sliderId: 'margin-right', valueId: 'margin-right-value', min: 0, max: 150, step: 1, suffix: 'px'},
                    {sliderId: 'saturation-slider', valueId: 'saturation-value', min: 0, max: 100, step: 1, suffix: ''},
                    {sliderId: 'video-volume-slider', valueId: 'video-volume-value', min: -100, max: 30, step: 1, suffix: 'db'},
                    {sliderId: 'overlay-opacity-slider', valueId: 'overlay-opacity-value', min: 0, max: 100, step: 1, suffix: '%'},
                    {sliderId: 'background-audio-volume-slider', valueId: 'background-audio-volume-value', min: -100, max: 30, step: 1, suffix: 'db'}
                ];

                sliderMappings.forEach(mapping => {
                    const slider = document.getElementById(mapping.sliderId);
                    const valueElement = document.getElementById(mapping.valueId);
                    
                    if (slider && valueElement && !mapping.valueId.includes('input')) {
                        // Rendi il valore cliccabile per editing diretto (solo per span, non input)
                        valueElement.addEventListener('click', () => {
                            this.startEditing(valueElement, slider, mapping);
                        });
                    }
                });
            }

            startEditing(valueElement, slider, mapping) {
                if (valueElement.classList.contains('range-value-editing')) return;
                
                const currentValue = parseFloat(slider.value);
                const input = document.createElement('input');
                input.type = 'number';
                input.value = currentValue.toFixed(2);
                input.min = mapping.min;
                input.max = mapping.max;
                input.step = mapping.step;
                input.className = 'range-value range-value-editing';
                
                // Calcola larghezza dinamica basata sul contenuto
                const maxValue = Math.max(Math.abs(mapping.min), Math.abs(mapping.max));
                const maxDigits = maxValue.toString().length;
                const decimals = mapping.step < 1 ? 2 : 0;
                const suffixLength = mapping.suffix ? mapping.suffix.length : 0;
                
                // Calcola larghezza minima necessaria (8px per carattere + padding)
                const estimatedWidth = Math.max(
                    (maxDigits + decimals + suffixLength + 2) * 8 + 16, // +2 per punto decimale e segno
                    valueElement.offsetWidth,
                    70 // Larghezza minima
                );
                
                input.style.width = estimatedWidth + 'px';
                input.style.textAlign = 'center';
                input.style.fontSize = getComputedStyle(valueElement).fontSize;
                input.style.fontFamily = getComputedStyle(valueElement).fontFamily;
                input.style.margin = getComputedStyle(valueElement).margin;
                input.style.padding = getComputedStyle(valueElement).padding;
                
                // Sostituisci temporaneamente l'elemento
                const parent = valueElement.parentNode;
                parent.replaceChild(input, valueElement);
                input.focus();
                input.select();
                
                let isFinished = false; // Flag per evitare chiamate multiple
                
                const finishEditing = () => {
                    if (isFinished) return; // Evita chiamate multiple
                    isFinished = true;
                    
                    try {
                        const newValue = parseFloat(input.value);
                        if (!isNaN(newValue) && newValue >= mapping.min && newValue <= mapping.max) {
                            slider.value = newValue;
                            valueElement.textContent = newValue.toFixed(2) + mapping.suffix;
                            this.saveSettings();
                            
                            // Aggiorna preview se sono controlli dei margini o altri che influiscono sulla preview
                            if (['margin-top', 'margin-bottom', 'margin-left', 'margin-right', 'block-height'].includes(mapping.sliderId)) {
                                this.updateBannerPreview();
                            }
                        }
                        
                        // Verifica che l'input sia ancora nel DOM prima di sostituirlo
                        if (input.parentNode === parent) {
                            parent.replaceChild(valueElement, input);
                        }
                    } catch (error) {
                        console.warn('Errore durante finishEditing:', error);
                        // In caso di errore, assicurati che valueElement sia nel DOM
                        if (!document.contains(valueElement) && document.contains(parent)) {
                            parent.appendChild(valueElement);
                        }
                    }
                };
                
                input.addEventListener('blur', finishEditing);
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === 'Escape') {
                        e.preventDefault();
                        finishEditing();
                    }
                });
            }

            setupRangeInputs() {
                // Event listeners per i range input
                const rangeInputs = [{
                    id: 'margin-top',
                    valueId: 'margin-top-value',
                    suffix: 'px'
                }, {
                    id: 'margin-bottom',
                    valueId: 'margin-bottom-value',
                    suffix: 'px'
                }, {
                    id: 'margin-left',
                    valueId: 'margin-left-value',
                    suffix: 'px'
                }, {
                    id: 'margin-right',
                    valueId: 'margin-right-value',
                    suffix: 'px'
                }, {
                    id: 'block-height',
                    valueId: 'block-height-value',
                    suffix: 'px'
                }];

                // Funzione generale per rendere i valori degli slider editabili
                this.makeSliderValuesEditable();

                // Gestione speciale per il temperature slider
                const temperatureSlider = document.getElementById('temperature-slider');
                const temperatureInput = document.getElementById('temperature-input');

                if (temperatureSlider && temperatureInput) {
                    // Sincronizza slider -> input
                    temperatureSlider.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        temperatureInput.value = value.toFixed(2);
                        this.saveSettings();
                    });

                    // Sincronizza input -> slider
                    temperatureInput.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        if (!isNaN(value) && value >= 0 && value <= 2) {
                            temperatureSlider.value = value;
                            this.saveSettings();
                        }
                    });

                    // Imposta i valori iniziali
                    const initialValue = parseFloat(temperatureSlider.value);
                    temperatureInput.value = initialValue.toFixed(2);
                }

                // Gestione speciale per il video speed slider
                const videoSpeedSlider = document.getElementById('video-speed-slider');
                const videoSpeedValue = document.getElementById('video-speed-value');

                if (videoSpeedSlider && videoSpeedValue) {
                    videoSpeedSlider.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        videoSpeedValue.textContent = value.toFixed(2) + 'x';
                        this.saveSettings();
                    });

                    // Imposta il valore iniziale
                    videoSpeedValue.textContent = parseFloat(videoSpeedSlider.value).toFixed(2) + 'x';
                }

                // Gestione speciale per il video zoom slider
                const videoZoomSlider = document.getElementById('video-zoom-slider');
                const videoZoomValue = document.getElementById('video-zoom-value');

                if (videoZoomSlider && videoZoomValue) {
                    videoZoomSlider.addEventListener('input', (e) => {
                        const value = parseFloat(e.target.value);
                        videoZoomValue.textContent = value.toFixed(2) + 'x';
                        this.saveSettings();
                    });

                    // Imposta il valore iniziale
                    videoZoomValue.textContent = parseFloat(videoZoomSlider.value).toFixed(2) + 'x';
                }

                // Gestione controlli per i nuovi parametri video
                this.setupVideoParametersControls();

                rangeInputs.forEach(({
                    id,
                    valueId,
                    suffix
                }) => {
                    const input = document.getElementById(id);
                    const valueSpan = document.getElementById(valueId);

                    if (input && valueSpan) {
                        // Aggiorna il valore quando l'utente muove lo slider
                        input.addEventListener('input', (e) => {
                            valueSpan.textContent = e.target.value + suffix;
                            // Aggiorna il preview dashboard
                            this.updateBannerPreview();
                            // Salva automaticamente le impostazioni
                            this.saveSettings();
                        });

                        // Imposta il valore iniziale
                        valueSpan.textContent = input.value + suffix;
                    }
                });
            }

            setupVideoParametersControls() {
                // Setup per Contrasto
                const contrastSlider = document.getElementById('contrast-slider');
                const contrastValue = document.getElementById('contrast-value');
                if (contrastSlider && contrastValue) {
                    contrastSlider.addEventListener('input', (e) => {
                        contrastValue.textContent = parseFloat(e.target.value).toFixed(2);
                        this.saveSettings();
                    });
                    contrastValue.textContent = parseFloat(contrastSlider.value).toFixed(2);
                }

                // Setup per Saturazione
                const saturationSlider = document.getElementById('saturation-slider');
                const saturationValue = document.getElementById('saturation-value');
                if (saturationSlider && saturationValue) {
                    saturationSlider.addEventListener('input', (e) => {
                        saturationValue.textContent = parseFloat(e.target.value).toFixed(2);
                        this.saveSettings();
                    });
                    saturationValue.textContent = parseFloat(saturationSlider.value).toFixed(2);
                }

                // Setup per Gamma
                const gammaSlider = document.getElementById('gamma-slider');
                const gammaValue = document.getElementById('gamma-value');
                if (gammaSlider && gammaValue) {
                    gammaSlider.addEventListener('input', (e) => {
                        gammaValue.textContent = parseFloat(e.target.value).toFixed(2);
                        this.saveSettings();
                    });
                    gammaValue.textContent = parseFloat(gammaSlider.value).toFixed(2);
                }

                // Setup per Lift
                const liftSlider = document.getElementById('lift-slider');
                const liftValue = document.getElementById('lift-value');
                if (liftSlider && liftValue) {
                    liftSlider.addEventListener('input', (e) => {
                        liftValue.textContent = parseFloat(e.target.value).toFixed(2);
                        this.saveSettings();
                    });
                    liftValue.textContent = parseFloat(liftSlider.value).toFixed(2);
                }

                // Setup per Volume Video
                const videoVolumeSlider = document.getElementById('video-volume-slider');
                const videoVolumeValue = document.getElementById('video-volume-value');
                if (videoVolumeSlider && videoVolumeValue) {
                    videoVolumeSlider.addEventListener('input', (e) => {
                        videoVolumeValue.textContent = e.target.value + 'db';
                        this.saveSettings();
                    });
                    videoVolumeValue.textContent = videoVolumeSlider.value + 'db';
                }

                // Setup per Volume Audio di Sottofondo
                const bgAudioVolumeSlider = document.getElementById('background-audio-volume-slider');
                const bgAudioVolumeValue = document.getElementById('background-audio-volume-value');
                if (bgAudioVolumeSlider && bgAudioVolumeValue) {
                    bgAudioVolumeSlider.addEventListener('input', (e) => {
                        bgAudioVolumeValue.textContent = e.target.value + 'db';
                        this.saveSettings();
                    });
                    bgAudioVolumeValue.textContent = bgAudioVolumeSlider.value + 'db';
                }

                // Setup per Overlay Opacity
                const overlayOpacitySlider = document.getElementById('overlay-opacity-slider');
                const overlayOpacityValue = document.getElementById('overlay-opacity-value');
                if (overlayOpacitySlider && overlayOpacityValue) {
                    overlayOpacitySlider.addEventListener('input', (e) => {
                        overlayOpacityValue.textContent = e.target.value + '%';
                        this.saveSettings();
                    });
                    overlayOpacityValue.textContent = overlayOpacitySlider.value + '%';
                }

                // Setup per Checkbox Overlay Image
                const overlayImageEnabled = document.getElementById('overlay-image-enabled');
                const overlayImageControls = document.getElementById('overlay-image-controls');
                const overlayImageSelect = document.getElementById('overlay-image-select');
                const overlayImageOpacitySlider = document.getElementById('overlay-opacity-slider');

                if (overlayImageEnabled && overlayImageControls) {
                    overlayImageEnabled.addEventListener('change', (e) => {
                        const isEnabled = e.target.checked;
                        overlayImageControls.style.display = isEnabled ? 'block' : 'none';

                        if (overlayImageSelect) overlayImageSelect.disabled = !isEnabled;
                        if (overlayImageOpacitySlider) overlayImageOpacitySlider.disabled = !isEnabled;

                        this.saveSettings();
                    });
                }

                // Setup per Checkbox Replace Audio
                const replaceAudioEnabled = document.getElementById('replace-audio-enabled');
                const replaceAudioControls = document.getElementById('replace-audio-controls');
                const replaceAudioFolderSelect = document.getElementById('replace-audio-folder-select');

                if (replaceAudioEnabled && replaceAudioControls) {
                    replaceAudioEnabled.addEventListener('change', (e) => {
                        const isEnabled = e.target.checked;
                        replaceAudioControls.style.display = isEnabled ? 'block' : 'none';

                        if (replaceAudioFolderSelect) replaceAudioFolderSelect.disabled = !isEnabled;

                        this.saveSettings();
                    });
                }

                // Setup per Checkbox Background Audio
                const bgAudioEnabled = document.getElementById('background-audio-enabled');
                const bgAudioControls = document.getElementById('background-audio-controls');
                const bgAudioSelect = document.getElementById('background-audio-select');
                const bgAudioVolSlider = document.getElementById('background-audio-volume-slider');

                if (bgAudioEnabled && bgAudioControls) {
                    bgAudioEnabled.addEventListener('change', (e) => {
                        const isEnabled = e.target.checked;
                        bgAudioControls.style.display = isEnabled ? 'block' : 'none';

                        if (bgAudioSelect) bgAudioSelect.disabled = !isEnabled;
                        if (bgAudioVolSlider) bgAudioVolSlider.disabled = !isEnabled;

                        this.saveSettings();
                    });
                }

                // Setup per file selection buttons
                this.setupFileSelectionButtons();
            }

            setupFileSelectionButtons() {
                // Button per selezionare immagine overlay
                const overlayImageSelect = document.getElementById('overlay-image-select');
                if (overlayImageSelect) {
                    overlayImageSelect.addEventListener('click', async() => {
                        try {
                            const result = await window.electronAPI.selectFile(['jpg', 'jpeg', 'png', 'bmp', 'gif']);
                            if (result) {
                                document.getElementById('overlay-image-filename').textContent = result.name;
                                this.overlayImagePath = result.path;
                                this.saveSettings();
                            }
                        } catch (error) {
                            console.error('Errore nella selezione immagine:', error);
                        }
                    });
                }

                // Button per selezionare cartella audio per sostituzione
                const replaceAudioFolderSelect = document.getElementById('replace-audio-folder-select');
                if (replaceAudioFolderSelect) {
                    replaceAudioFolderSelect.addEventListener('click', async() => {
                        try {
                            const result = await window.electronAPI.selectDirectory();
                            if (result) {
                                document.getElementById('replace-audio-folder-info').textContent = `Cartella: ${result.name}`;
                                this.replaceAudioFolderPath = result.path;
                                await this.scanAudioFolder();
                                this.saveSettings();
                            }
                        } catch (error) {
                            console.error('Errore nella selezione cartella audio:', error);
                        }
                    });
                }

                // Button per selezionare audio di sottofondo
                const bgAudioSelect = document.getElementById('background-audio-select');
                if (bgAudioSelect) {
                    bgAudioSelect.addEventListener('click', async() => {
                        try {
                            const result = await window.electronAPI.selectFile(['mp3', 'wav', 'aac', 'flac', 'm4a']);
                            if (result) {
                                document.getElementById('background-audio-filename').textContent = result.name;
                                this.backgroundAudioPath = result.path;
                                this.saveSettings();
                            }
                        } catch (error) {
                            console.error('Errore nella selezione audio:', error);
                        }
                    });
                }
            }

            async loadInitialData() {
                try {
                    // Carica font
                    const fonts = await window.electronAPI.loadFonts();
                    console.log('Font caricati:', fonts);
                    await this.loadFontsIntoCSS(fonts);
                    this.populateFontSelect(fonts);

                    // Carica video
                    await this.refreshVideoList();

                    // Carica configurazione API
                    this.apiConfig = await window.electronAPI.loadApiConfig();

                    // CORREZIONE: Carica impostazioni dopo che i font sono completamente disponibili
                    // Aspetta un momento aggiuntivo per assicurarsi che i font siano nel DOM
                    setTimeout(async() => {
                        await this.loadSettings();
                    }, 1000); // Aumentato da 500ms a 1000ms

                    console.log('Dati iniziali caricati con successo');
                } catch (error) {
                    console.error('Errore nel caricamento dati:', error.message);
                }
            }

            async loadFontsIntoCSS(fonts) {
                // Rimuovi eventuali stili font precedenti
                const existingStyle = document.getElementById('dynamic-fonts');
                if (existingStyle) {
                    existingStyle.remove();
                }

                console.log('Caricamento CSS per font:', fonts);

                // Crea un elemento style per caricare i font
                const style = document.createElement('style');
                style.id = 'dynamic-fonts';

                let cssRules = '';
                fonts.forEach(font => {
                    // Rimuovi l'estensione dal nome del font per la famiglia CSS
                    const fontFamily = font.replace(/\.(ttf|otf|woff|woff2)$/i, '');

                    // CORREZIONE: Escapare le virgolette nei CSS per font con spazi nel nome
                    const escapedFontPath = font.replace(/"/g, '\\"').replace(/'/g, "\\'");
                    const escapedFontFamily = fontFamily.replace(/"/g, '\\"');

                    cssRules += `
                        @font-face {
                            font-family: "${escapedFontFamily}";
                            src: url("./font/${escapedFontPath}") format("truetype");
                            font-display: swap;
                            font-weight: normal;
                            font-style: normal;
                        }
                    `;
                });

                style.textContent = cssRules;
                document.head.appendChild(style);

                console.log('CSS aggiunto:', cssRules);

                // Usa FontFace API per preload se disponibile
                if ('fonts' in document) {
                    console.log('FontFace API disponibile, caricamento font...');
                    const fontPromises = fonts.map(async(font) => {
                        const fontFamily = font.replace(/\.(ttf|otf|woff|woff2)$/i, '');
                        try {
                            // CORREZIONE: Gestire font con spazi nei nomi
                            const fontFace = new FontFace(`"${fontFamily}"`, `url("./font/${font}")`);
                            const loadedFont = await fontFace.load();
                            document.fonts.add(loadedFont);
                            console.log(`‚úÖ Font ${fontFamily} caricato con successo`);
                        } catch (error) {
                            console.warn(`‚ùå Impossibile caricare il font ${fontFamily}:`, error);
                        }
                    });

                    await Promise.allSettled(fontPromises);
                    console.log('üé® Fonts nella document.fonts:', Array.from(document.fonts).map(f => f.family));
                }

                // Aspetta un momento per permettere ai font di caricarsi
                await new Promise(resolve => setTimeout(resolve, 800));
            }

            // Funzioni helper per gestire il conflitto metadati
            showMetadataConflictWarning() {
                const warning = document.getElementById('metadata-conflict-warning');
                if (warning) {
                    warning.style.display = 'block';
                }
            }

            hideMetadataConflictWarning() {
                const warning = document.getElementById('metadata-conflict-warning');
                if (warning) {
                    warning.style.display = 'none';
                }
            }

            // Gestione delle impostazioni
            async loadSettings() {
                try {
                    const settings = await window.electronAPI.loadSettings();
                    console.log('Impostazioni caricate:', settings);

                    // Applica le impostazioni ai controlli
                    if (settings.fontFamily) {
                        console.log('Tentativo di caricare font:', settings.fontFamily);

                        // Prima prova con il nome esatto
                        let fontOption = document.querySelector(`[data-value="${settings.fontFamily}"]`);
                        console.log('Font option trovata:', fontOption);

                        // Se non trova il font esatto, prova alcune varianti comuni
                        if (!fontOption) {
                            const fontVariants = [
                                settings.fontFamily.toLowerCase(), // "Impact" -> "impact"
                                settings.fontFamily + 'ed', // "Impact" -> "Impacted"
                                settings.fontFamily.toUpperCase(), // "impact" -> "IMPACT"
                                'impact', // Default fallback
                                'Impacted' // Alternative default
                            ];

                            console.log('Tentativo varianti font:', fontVariants);

                            for (const variant of fontVariants) {
                                fontOption = document.querySelector(`[data-value="${variant}"]`);
                                if (fontOption) {
                                    console.log(`Font trovato con variante "${variant}":`, fontOption);
                                    break;
                                }
                            }
                        }

                        if (fontOption) {
                            this.selectFont(fontOption.dataset.value, fontOption.textContent);
                            console.log('Font selezionato:', fontOption.dataset.value);
                        } else {
                            console.warn('Font option non trovata per:', settings.fontFamily);
                            console.log('Opzioni disponibili:', Array.from(document.querySelectorAll('[data-value]')).map(opt => opt.dataset.value));

                            // Fallback su impact se disponibile
                            const impactOption = document.querySelector(`[data-value="impact"]`);
                            if (impactOption) {
                                this.selectFont('impact', impactOption.textContent);
                                console.log('Utilizzato fallback: impact');
                            }
                        }
                    }

                    if (settings.marginTop !== undefined) {
                        const marginTopInput = document.getElementById('margin-top');
                        const marginTopValue = document.getElementById('margin-top-value');
                        if (marginTopInput && marginTopValue) {
                            marginTopInput.value = settings.marginTop;
                            marginTopValue.textContent = settings.marginTop + 'px';
                        }
                    }

                    if (settings.marginBottom !== undefined) {
                        const marginBottomInput = document.getElementById('margin-bottom');
                        const marginBottomValue = document.getElementById('margin-bottom-value');
                        if (marginBottomInput && marginBottomValue) {
                            marginBottomInput.value = settings.marginBottom;
                            marginBottomValue.textContent = settings.marginBottom + 'px';
                        }
                    }

                    if (settings.marginLeft !== undefined) {
                        const marginLeftInput = document.getElementById('margin-left');
                        const marginLeftValue = document.getElementById('margin-left-value');
                        if (marginLeftInput && marginLeftValue) {
                            marginLeftInput.value = settings.marginLeft;
                            marginLeftValue.textContent = settings.marginLeft + 'px';
                        }
                    }

                    if (settings.marginRight !== undefined) {
                        const marginRightInput = document.getElementById('margin-right');
                        const marginRightValue = document.getElementById('margin-right-value');
                        if (marginRightInput && marginRightValue) {
                            marginRightInput.value = settings.marginRight;
                            marginRightValue.textContent = settings.marginRight + 'px';
                        }
                    }

                    if (settings.blockHeight !== undefined) {
                        const blockHeightInput = document.getElementById('block-height');
                        const blockHeightValue = document.getElementById('block-height-value');
                        if (blockHeightInput && blockHeightValue) {
                            blockHeightInput.value = settings.blockHeight;
                            blockHeightValue.textContent = settings.blockHeight + 'px';
                        }
                    }

                    if (settings.textFormat) {
                        const textFormatSelect = document.getElementById('text-format');
                        if (textFormatSelect) {
                            textFormatSelect.value = settings.textFormat;
                        }
                    }

                    if (settings.temperature !== undefined) {
                        const temperatureSlider = document.getElementById('temperature-slider');
                        const temperatureValue = document.getElementById('temperature-value');
                        if (temperatureSlider && temperatureValue) {
                            temperatureSlider.value = settings.temperature;
                            temperatureValue.textContent = parseFloat(settings.temperature).toFixed(1);
                        }
                    }

                    if (settings.videoSpeed !== undefined) {
                        const videoSpeedSlider = document.getElementById('video-speed-slider');
                        const videoSpeedValue = document.getElementById('video-speed-value');
                        if (videoSpeedSlider && videoSpeedValue) {
                            videoSpeedSlider.value = settings.videoSpeed;
                            videoSpeedValue.textContent = parseFloat(settings.videoSpeed).toFixed(1) + 'x';
                        }
                    }

                    if (settings.videoZoom !== undefined) {
                        const videoZoomSlider = document.getElementById('video-zoom-slider');
                        const videoZoomValue = document.getElementById('video-zoom-value');
                        if (videoZoomSlider && videoZoomValue) {
                            videoZoomSlider.value = settings.videoZoom;
                            videoZoomValue.textContent = parseFloat(settings.videoZoom).toFixed(1) + 'x';
                        }
                    }

                    // Caricamento nuovi parametri video
                    if (settings.contrast !== undefined) {
                        const contrastSlider = document.getElementById('contrast-slider');
                        const contrastValue = document.getElementById('contrast-value');
                        if (contrastSlider && contrastValue) {
                            contrastSlider.value = settings.contrast;
                            contrastValue.textContent = parseFloat(settings.contrast).toFixed(1);
                        }
                    }

                    if (settings.saturation !== undefined) {
                        const saturationSlider = document.getElementById('saturation-slider');
                        const saturationValue = document.getElementById('saturation-value');
                        if (saturationSlider && saturationValue) {
                            saturationSlider.value = settings.saturation;
                            saturationValue.textContent = settings.saturation;
                        }
                    }

                    if (settings.gamma !== undefined) {
                        const gammaSlider = document.getElementById('gamma-slider');
                        const gammaValue = document.getElementById('gamma-value');
                        if (gammaSlider && gammaValue) {
                            gammaSlider.value = settings.gamma;
                            gammaValue.textContent = parseFloat(settings.gamma).toFixed(1);
                        }
                    }

                    if (settings.lift !== undefined) {
                        const liftSlider = document.getElementById('lift-slider');
                        const liftValue = document.getElementById('lift-value');
                        if (liftSlider && liftValue) {
                            liftSlider.value = settings.lift;
                            liftValue.textContent = parseFloat(settings.lift).toFixed(1);
                        }
                    }

                    if (settings.videoVolume !== undefined) {
                        const videoVolumeSlider = document.getElementById('video-volume-slider');
                        const videoVolumeValue = document.getElementById('video-volume-value');
                        if (videoVolumeSlider && videoVolumeValue) {
                            videoVolumeSlider.value = settings.videoVolume;
                            videoVolumeValue.textContent = settings.videoVolume + 'db';
                        }
                    }

                    if (settings.overlayImageEnabled !== undefined) {
                        const overlayEnabled = document.getElementById('overlay-image-enabled');
                        const overlayControls = document.getElementById('overlay-image-controls');
                        const overlaySelect = document.getElementById('overlay-image-select');
                        const overlayOpacitySlider = document.getElementById('overlay-opacity-slider');

                        if (overlayEnabled) {
                            overlayEnabled.checked = settings.overlayImageEnabled;
                            if (overlayControls) {
                                overlayControls.style.display = settings.overlayImageEnabled ? 'block' : 'none';
                            }
                            if (overlaySelect) overlaySelect.disabled = !settings.overlayImageEnabled;
                            if (overlayOpacitySlider) overlayOpacitySlider.disabled = !settings.overlayImageEnabled;
                        }

                        if (settings.overlayImagePath) {
                            this.overlayImagePath = settings.overlayImagePath;
                            const filename = settings.overlayImagePath.split('/').pop() || settings.overlayImagePath.split('\\').pop();
                            const filenameEl = document.getElementById('overlay-image-filename');
                            if (filenameEl) filenameEl.textContent = filename;
                        }
                    }

                    if (settings.overlayOpacity !== undefined) {
                        const overlayOpacitySlider = document.getElementById('overlay-opacity-slider');
                        const overlayOpacityValue = document.getElementById('overlay-opacity-value');
                        if (overlayOpacitySlider && overlayOpacityValue) {
                            overlayOpacitySlider.value = settings.overlayOpacity;
                            overlayOpacityValue.textContent = settings.overlayOpacity + '%';
                        }
                    }

                    if (settings.backgroundAudioEnabled !== undefined) {
                        const bgAudioEnabled = document.getElementById('background-audio-enabled');
                        const bgAudioControls = document.getElementById('background-audio-controls');
                        const bgAudioSelect = document.getElementById('background-audio-select');
                        const bgAudioVolumeSlider = document.getElementById('background-audio-volume-slider');

                        if (bgAudioEnabled) {
                            bgAudioEnabled.checked = settings.backgroundAudioEnabled;
                            if (bgAudioControls) {
                                bgAudioControls.style.display = settings.backgroundAudioEnabled ? 'block' : 'none';
                            }
                            if (bgAudioSelect) bgAudioSelect.disabled = !settings.backgroundAudioEnabled;
                            if (bgAudioVolumeSlider) bgAudioVolumeSlider.disabled = !settings.backgroundAudioEnabled;
                        }

                        if (settings.backgroundAudioPath) {
                            this.backgroundAudioPath = settings.backgroundAudioPath;
                            const filename = settings.backgroundAudioPath.split('/').pop() || settings.backgroundAudioPath.split('\\').pop();
                            const filenameEl = document.getElementById('background-audio-filename');
                            if (filenameEl) filenameEl.textContent = filename;
                        }
                    }

                    if (settings.backgroundAudioVolume !== undefined) {
                        const bgAudioVolumeSlider = document.getElementById('background-audio-volume-slider');
                        const bgAudioVolumeValue = document.getElementById('background-audio-volume-value');
                        if (bgAudioVolumeSlider && bgAudioVolumeValue) {
                            bgAudioVolumeSlider.value = settings.backgroundAudioVolume;
                            bgAudioVolumeValue.textContent = settings.backgroundAudioVolume + 'db';
                        }
                    }

                    if (settings.replaceAudioEnabled !== undefined) {
                        const replaceAudioEnabled = document.getElementById('replace-audio-enabled');
                        const replaceAudioControls = document.getElementById('replace-audio-controls');
                        const replaceAudioFolderSelect = document.getElementById('replace-audio-folder-select');

                        if (replaceAudioEnabled) {
                            replaceAudioEnabled.checked = settings.replaceAudioEnabled;
                            if (replaceAudioControls) {
                                replaceAudioControls.style.display = settings.replaceAudioEnabled ? 'block' : 'none';
                            }
                            if (replaceAudioFolderSelect) replaceAudioFolderSelect.disabled = !settings.replaceAudioEnabled;
                        }

                        if (settings.replaceAudioFolderPath) {
                            this.replaceAudioFolderPath = settings.replaceAudioFolderPath;
                            const folderName = settings.replaceAudioFolderPath.split('/').pop() || settings.replaceAudioFolderPath.split('\\').pop();
                            const folderInfoEl = document.getElementById('replace-audio-folder-info');
                            if (folderInfoEl) folderInfoEl.textContent = `Cartella: ${folderName}`;
                            
                            // Scansiona automaticamente la cartella al caricamento
                            setTimeout(() => this.scanAudioFolder(), 500);
                        }
                    }

                    if (settings.removeBlackFrameEnabled !== undefined) {
                        const removeBlackFrameCheckbox = document.getElementById('remove-black-frame-enabled');
                        if (removeBlackFrameCheckbox) {
                            removeBlackFrameCheckbox.checked = settings.removeBlackFrameEnabled;
                        }
                    }

                    if (settings.addMetadataEnabled !== undefined) {
                        const addMetadataCheckbox = document.getElementById('add-metadata-enabled');
                        if (addMetadataCheckbox) {
                            addMetadataCheckbox.checked = settings.addMetadataEnabled;
                        }
                    }

                    if (settings.removeMetadataEnabled !== undefined) {
                        const removeMetadataCheckbox = document.getElementById('remove-metadata-enabled');
                        if (removeMetadataCheckbox) {
                            removeMetadataCheckbox.checked = settings.removeMetadataEnabled;
                        }
                    }

                    // Controllo di mutua esclusivit√† al caricamento
                    const addMetadataCheckbox = document.getElementById('add-metadata-enabled');
                    const removeMetadataCheckbox = document.getElementById('remove-metadata-enabled');
                    if (addMetadataCheckbox && removeMetadataCheckbox) {
                        if (addMetadataCheckbox.checked && removeMetadataCheckbox.checked) {
                            // Priorit√† a "Elimina Metadati" se entrambi sono true
                            addMetadataCheckbox.checked = false;
                            this.showMetadataConflictWarning();
                        } else {
                            this.hideMetadataConflictWarning();
                        }
                    }

                    // Aggiorna il preview dashboard dopo aver caricato le impostazioni
                    setTimeout(() => this.updateBannerPreview(), 100);

                } catch (error) {
                    console.error('Errore nel caricamento delle impostazioni:', error);
                }
            }

            async saveSettings() {
                try {
                    const settings = {
                        fontFamily: this.elements.selectedFont.textContent.split(' - ')[0] || 'Impact',
                        marginTop: parseInt(document.getElementById('margin-top') && document.getElementById('margin-top').value || 30),
                        marginBottom: parseInt(document.getElementById('margin-bottom') && document.getElementById('margin-bottom').value || 30),
                        marginLeft: parseInt(document.getElementById('margin-left') && document.getElementById('margin-left').value || 40),
                        marginRight: parseInt(document.getElementById('margin-right') && document.getElementById('margin-right').value || 40),
                        blockHeight: parseInt(document.getElementById('block-height') && document.getElementById('block-height').value || 450),
                        textFormat: document.getElementById('text-format') && document.getElementById('text-format').value || 'normal',
                        temperature: parseFloat(document.getElementById('temperature-slider') && document.getElementById('temperature-slider').value || 1),
                        videoSpeed: parseFloat(document.getElementById('video-speed-slider') && document.getElementById('video-speed-slider').value || 1),
                        videoZoom: parseFloat(document.getElementById('video-zoom-slider') && document.getElementById('video-zoom-slider').value || 1),
                        // Nuovi parametri video
                        contrast: parseFloat(document.getElementById('contrast-slider') && document.getElementById('contrast-slider').value || 1),
                        saturation: parseInt(document.getElementById('saturation-slider') && document.getElementById('saturation-slider').value || 50),
                        gamma: parseFloat(document.getElementById('gamma-slider') && document.getElementById('gamma-slider').value || 0),
                        lift: parseFloat(document.getElementById('lift-slider') && document.getElementById('lift-slider').value || 0),
                        videoVolume: parseInt(document.getElementById('video-volume-slider') && document.getElementById('video-volume-slider').value || 0),
                        overlayImageEnabled: document.getElementById('overlay-image-enabled') && document.getElementById('overlay-image-enabled').checked || false,
                        overlayImagePath: this.overlayImagePath || '',
                        overlayOpacity: parseInt(document.getElementById('overlay-opacity-slider') && document.getElementById('overlay-opacity-slider').value || 50),
                        backgroundAudioEnabled: document.getElementById('background-audio-enabled') && document.getElementById('background-audio-enabled').checked || false,
                        backgroundAudioPath: this.backgroundAudioPath || '',
                        backgroundAudioVolume: parseInt(document.getElementById('background-audio-volume-slider') && document.getElementById('background-audio-volume-slider').value || 0),
                        replaceAudioEnabled: document.getElementById('replace-audio-enabled') && document.getElementById('replace-audio-enabled').checked || false,
                        replaceAudioFolderPath: this.replaceAudioFolderPath || '',
                        removeBlackFrameEnabled: document.getElementById('remove-black-frame-enabled') && document.getElementById('remove-black-frame-enabled').checked || false,
                        addMetadataEnabled: document.getElementById('add-metadata-enabled') && document.getElementById('add-metadata-enabled').checked || false,
                        removeMetadataEnabled: document.getElementById('remove-metadata-enabled') && document.getElementById('remove-metadata-enabled').checked || false
                    };

                    console.log('Salvataggio impostazioni:', settings);
                    await window.electronAPI.saveSettings(settings);

                } catch (error) {
                    console.error('Errore nel salvataggio delle impostazioni:', error);
                }
            }

            populateFontSelect(fonts) {
                const displayElement = this.elements.fontSelect.querySelector('.select-display');
                displayElement.textContent = 'Seleziona un font...';

                this.elements.fontOptions.innerHTML = '';

                if (fonts.length === 0) {
                    displayElement.textContent = 'Nessun font trovato';
                    return;
                }

                fonts.forEach(font => {
                    const fontFamily = font.replace(/\.(ttf|otf|woff|woff2)$/i, '');
                    const option = document.createElement('div');
                    option.className = 'select-option';
                    option.textContent = `${fontFamily} - ABC abc 123`;
                    option.style.fontFamily = `"${fontFamily}", Arial, sans-serif`;
                    option.dataset.value = fontFamily;

                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.selectFont(fontFamily, option.textContent);
                    });

                    this.elements.fontOptions.appendChild(option);
                });

                // Forza il browser a riconoscere i font caricati
                this.preloadFonts(fonts);
            }

            selectFont(fontFamily, displayText) {
                // Aggiorna il campo nascosto
                this.elements.selectedFont.value = fontFamily;

                // Aggiorna la visualizzazione
                const displayElement = this.elements.fontSelect.querySelector('.select-display');
                displayElement.textContent = displayText;
                displayElement.style.fontFamily = `"${fontFamily}", Arial, sans-serif`;

                // Rimuovi selezione precedente
                this.elements.fontOptions.querySelectorAll('.select-option').forEach(opt => {
                    opt.classList.remove('selected');
                });

                // Aggiungi selezione corrente
                const selectedOption = this.elements.fontOptions.querySelector(`[data-value="${fontFamily}"]`);
                if (selectedOption) {
                    selectedOption.classList.add('selected');
                }

                // Chiudi dropdown
                this.closeFontDropdown();

                // Salva automaticamente le impostazioni
                this.saveSettings();
            }

            toggleFontDropdown() {
                const isOpen = this.elements.fontSelect.classList.contains('open');
                if (isOpen) {
                    this.closeFontDropdown();
                } else {
                    this.openFontDropdown();
                }
            }

            openFontDropdown() {
                this.elements.fontSelect.classList.add('open');
                this.elements.fontOptions.classList.add('show');
            }

            closeFontDropdown() {
                this.elements.fontSelect.classList.remove('open');
                this.elements.fontOptions.classList.remove('show');
            }

            preloadFonts(fonts) {
                // Crea elementi temporanei invisibili per forzare il caricamento dei font
                fonts.forEach(font => {
                    const fontFamily = font.replace(/\.(ttf|otf|woff|woff2)$/i, '');
                    const testElement = document.createElement('div');
                    testElement.style.fontFamily = `"${fontFamily}", Arial, sans-serif`;
                    testElement.style.fontSize = '16px';
                    testElement.style.visibility = 'hidden';
                    testElement.style.position = 'absolute';
                    testElement.style.left = '-9999px';
                    testElement.textContent = 'ABC abc 123 Font Test';
                    document.body.appendChild(testElement);

                    // Rimuovi dopo un delay pi√π lungo per permettere il caricamento
                    setTimeout(() => {
                        if (testElement.parentNode) {
                            testElement.parentNode.removeChild(testElement);
                        }
                    }, 2000);
                });

                // Forza il repaint dopo un breve delay
                setTimeout(() => {
                    this.elements.fontSelect.style.display = 'none';
                    this.elements.fontSelect.offsetHeight; // trigger reflow
                    this.elements.fontSelect.style.display = '';
                }, 1000);
            }

            // DASHBOARD PREVIEW: Aggiorna il preview visivo dei banner e margini - COMPLETAMENTE RISCRITTA
            updateBannerPreview() {
                // Ottieni i valori dai slider in modo sicuro
                const marginTopEl = document.getElementById('margin-top');
                const marginBottomEl = document.getElementById('margin-bottom');
                const marginLeftEl = document.getElementById('margin-left');
                const marginRightEl = document.getElementById('margin-right');

                const marginTop = marginTopEl ? parseInt(marginTopEl.value) || 0 : 0;
                const marginBottom = marginBottomEl ? parseInt(marginBottomEl.value) || 0 : 0;
                const marginLeft = marginLeftEl ? parseInt(marginLeftEl.value) || 0 : 0;
                const marginRight = marginRightEl ? parseInt(marginRightEl.value) || 0 : 0;

                // Aggiorna il display dei margini
                const marginDisplay = document.getElementById('margin-display');
                if (marginDisplay) {
                    marginDisplay.textContent = `T${marginTop} B${marginBottom} L${marginLeft} R${marginRight}`;
                }

                // Dimensioni del "video" nel preview
                const previewVideoWidth = 320;
                const previewVideoHeight = 240;

                // Banner copre tutta la larghezza del video (specifiche utente)
                const bannerWidth = previewVideoWidth;

                // Altezza proporzionale usando il valore dall'interfaccia utente
                const blockHeightEl = document.getElementById('block-height');
                const userBlockHeight = blockHeightEl ? parseInt(blockHeightEl.value) : 450;
                const bannerHeight = Math.round((previewVideoHeight * userBlockHeight) / 1920);

                // Calcola l'area effettiva disponibile per il testo
                const textAreaWidth = bannerWidth - marginLeft - marginRight;
                const textAreaHeight = bannerHeight - marginTop - marginBottom;

                // Controlla se tutti i margini sono zero (modalit√† full banner)
                const allMarginsZero = marginTop === 0 && marginBottom === 0 && marginLeft === 0 && marginRight === 0;

                // Aggiorna il display dell'area testo
                const textAreaDisplay = document.getElementById('text-area-display');
                if (textAreaDisplay) {
                    textAreaDisplay.textContent = `${textAreaWidth}√ó${textAreaHeight}px`;
                }

                // AGGIORNA I BANNER PREVIEW
                const topBanner = document.getElementById('banner-top-preview');
                const bottomBanner = document.getElementById('banner-bottom-preview');

                if (topBanner && bottomBanner) {
                    // I banner coprono sempre tutta la larghezza
                    topBanner.style.height = `${bannerHeight}px`;
                    bottomBanner.style.height = `${bannerHeight}px`;
                }

                // AGGIORNA LE AREE TESTO DINAMICHE
                ['top', 'bottom'].forEach(position => {
                    const textAreaRect = document.getElementById(`text-area-${position}`);
                    if (textAreaRect) {
                        // Posiziona il rettangolo dell'area testo considerando i margini
                        textAreaRect.style.left = `${marginLeft}px`;
                        textAreaRect.style.top = `${marginTop}px`;
                        textAreaRect.style.width = `${Math.max(textAreaWidth, 20)}px`;
                        textAreaRect.style.height = `${Math.max(textAreaHeight, 15)}px`;

                        // Cambia stile se √® modalit√† full banner (tutti margini = 0)
                        if (allMarginsZero) {
                            textAreaRect.classList.add('full-banner');
                        } else {
                            textAreaRect.classList.remove('full-banner');
                        }
                    }
                });

                console.log(`üé¨ Preview aggiornato: banner ${bannerWidth}px, altezza ${bannerHeight}px, margini T${marginTop} B${marginBottom} L${marginLeft} R${marginRight}, area testo ${textAreaWidth}√ó${textAreaHeight}px`);
            }

            async scanAudioFolder() {
                if (!this.replaceAudioFolderPath) {
                    console.log('üîÑ Nessuna cartella audio selezionata');
                    return;
                }

                try {
                    console.log('üîÑ Scansione cartella audio:', this.replaceAudioFolderPath);
                    const audioFiles = await window.electronAPI.scanAudioFolder(this.replaceAudioFolderPath);
                    
                    // Filtra solo file audio supportati
                    const supportedAudioFiles = audioFiles.filter(file => {
                        const ext = file.toLowerCase();
                        return ext.endsWith('.mp3') || ext.endsWith('.wav') || 
                               ext.endsWith('.aac') || ext.endsWith('.flac') || 
                               ext.endsWith('.m4a') || ext.endsWith('.ogg');
                    });

                    console.log(`üéµ Trovati ${supportedAudioFiles.length} file audio nella cartella`);
                    
                    // Aggiorna status
                    const statusElement = document.getElementById('replace-audio-status');
                    if (statusElement) {
                        if (supportedAudioFiles.length > 0) {
                            statusElement.textContent = `‚úÖ Trovati ${supportedAudioFiles.length} file audio compatibili`;
                            statusElement.style.color = '#27ae60';
                        } else {
                            statusElement.textContent = '‚ö†Ô∏è Nessun file audio compatibile trovato';
                            statusElement.style.color = '#e74c3c';
                        }
                    }

                    // Il reset degli audio usati avverr√† nel backend all'inizio dell'elaborazione

                } catch (error) {
                    console.error('‚ùå Errore nella scansione della cartella audio:', error);
                    const statusElement = document.getElementById('replace-audio-status');
                    if (statusElement) {
                        statusElement.textContent = '‚ùå Errore nella lettura della cartella';
                        statusElement.style.color = '#e74c3c';
                    }
                }
            }

            async refreshVideoList() {
                try {
                    const videos = await window.electronAPI.getInputVideos();
                    this.elements.videoCount.textContent = videos.length;

                    if (videos.length === 0) {
                        this.elements.videoList.innerHTML =
                            '<div class="video-item">Nessun video trovato nella cartella INPUT</div>';
                    } else {
                        this.elements.videoList.innerHTML = videos
                            .map(video => `<div class="video-item">üìπ ${video}</div>`)
                            .join('');
                    }
                } catch (error) {
                    console.error('Errore nel caricamento video:', error.message);
                }
            }

            async startProcessing() {
                    if (this.isProcessing) return;

                    // Validazioni con messaggi dettagliati
                    const missingFields = [];

                    if (!this.elements.memeType.value.trim()) {
                        missingFields.push('üìù Tipologia di meme');
                    }

                    if (!this.elements.videoFilter.value.trim()) {
                        missingFields.push('üé¨ Criteri per il filtro video');
                    }

                    if (!this.elements.memeStyle.value.trim()) {
                        missingFields.push('‚ú® Stile del meme');
                    }

                    if (!this.elements.selectedFont.value) {
                        missingFields.push('üé® Font per il testo');
                    }
                    if (missingFields.length > 0) {
                        const message = `‚ö†Ô∏è CAMPI MANCANTI\n\nPer continuare devi compilare:\n\n${missingFields.map(field => `‚Ä¢ ${field}`).join('\n')}`;
                    alert(message);
                    return;
                }

                // Prepara configurazione
                const config = {
                    memeType: this.elements.memeType.value.trim(),
                    videoFilter: this.elements.videoFilter.value.trim(),
                    memeStyle: this.elements.memeStyle.value.trim(),
                    useCollage: this.elements.collageMode.checked,
                    selectedFont: this.elements.selectedFont && this.elements.selectedFont.value || 'impact',
                    textFormat: this.elements.textFormat && this.elements.textFormat.value || 'normal',
                    temperature: parseFloat(document.getElementById('temperature-slider') && document.getElementById('temperature-slider').value || 1),
                    videoSpeed: parseFloat(document.getElementById('video-speed-slider') && document.getElementById('video-speed-slider').value || 1),
                    videoZoom: parseFloat(document.getElementById('video-zoom-slider') && document.getElementById('video-zoom-slider').value || 1),
                    // Nuovi parametri video
                    contrast: parseFloat(document.getElementById('contrast-slider') && document.getElementById('contrast-slider').value || 1),
                    saturation: parseInt(document.getElementById('saturation-slider') && document.getElementById('saturation-slider').value || 50),
                    gamma: parseFloat(document.getElementById('gamma-slider') && document.getElementById('gamma-slider').value || 0),
                    lift: parseFloat(document.getElementById('lift-slider') && document.getElementById('lift-slider').value || 0),
                    videoVolume: parseInt(document.getElementById('video-volume-slider') && document.getElementById('video-volume-slider').value || 0),
                    overlayImageEnabled: document.getElementById('overlay-image-enabled') && document.getElementById('overlay-image-enabled').checked || false,
                    overlayImagePath: this.overlayImagePath || '',
                    overlayOpacity: parseInt(document.getElementById('overlay-opacity-slider') && document.getElementById('overlay-opacity-slider').value || 50),
                    backgroundAudioEnabled: document.getElementById('background-audio-enabled') && document.getElementById('background-audio-enabled').checked || false,
                    backgroundAudioPath: this.backgroundAudioPath || '',
                    backgroundAudioVolume: parseInt(document.getElementById('background-audio-volume-slider') && document.getElementById('background-audio-volume-slider').value || 0),
                    replaceAudioEnabled: document.getElementById('replace-audio-enabled') && document.getElementById('replace-audio-enabled').checked || false,
                    replaceAudioFolderPath: this.replaceAudioFolderPath || '',
                    removeBlackFrameEnabled: document.getElementById('remove-black-frame-enabled') && document.getElementById('remove-black-frame-enabled').checked || false,
                    addMetadataEnabled: document.getElementById('add-metadata-enabled') && document.getElementById('add-metadata-enabled').checked || false,
                    removeMetadataEnabled: document.getElementById('remove-metadata-enabled') && document.getElementById('remove-metadata-enabled').checked || false
                };

                // Gestione sicura dei margini (permette il valore 0)
                const marginTopEl = document.getElementById('margin-top');
                const marginBottomEl = document.getElementById('margin-bottom');
                const marginLeftEl = document.getElementById('margin-left');
                const marginRightEl = document.getElementById('margin-right');
                
                config.marginTop = marginTopEl ? parseInt(marginTopEl.value) : 30;
                config.marginBottom = marginBottomEl ? parseInt(marginBottomEl.value) : 30;
                config.marginLeft = marginLeftEl ? parseInt(marginLeftEl.value) : 40;
                config.marginRight = marginRightEl ? parseInt(marginRightEl.value) : 40;
                
                // Gestisce il caso in cui parseInt restituisca NaN
                if (isNaN(config.marginTop)) config.marginTop = 30;
                if (isNaN(config.marginBottom)) config.marginBottom = 30;
                if (isNaN(config.marginLeft)) config.marginLeft = 40;
                if (isNaN(config.marginRight)) config.marginRight = 40;

                // Gestione sicura dell'altezza del blocco
                const blockHeightEl = document.getElementById('block-height');
                config.blockHeight = blockHeightEl ? parseInt(blockHeightEl.value) : 450;
                if (isNaN(config.blockHeight) || config.blockHeight < 200) config.blockHeight = 450;

                try {
                    this.setProcessingState(true);
                    console.log('Avvio elaborazione...');

                    const result = await window.electronAPI.startProcessing(config);
                    console.log(result.message);

                    // Mostra risultati del processamento banner se disponibili
                    if (result.bannerResults) {
                        const bannerRes = result.bannerResults;
                        if (bannerRes.error) {
                            console.warn('Processamento banner fallito:', bannerRes.error);
                        } else {
                            console.log(`Banner processati: ${bannerRes.processedVideos}/${bannerRes.validVideos} video elaborati`);
                            if (bannerRes.skippedVideos > 0) {
                                console.log(`Video saltati per errori: ${bannerRes.skippedVideos}`);
                            }
                        }
                    }

                } catch (error) {
                    console.error('Errore:', error.message);
                    this.setProcessingState(false);
                }
            }

            async stopProcessing() {
                try {
                    await window.electronAPI.stopProcessing();
                    this.setProcessingState(false);
                    console.log('Elaborazione interrotta dall\'utente');
                } catch (error) {
                    console.error('Errore nella terminazione:', error.message);
                }
            }

            setProcessingState(processing) {
                this.isProcessing = processing;
                this.elements.startBtn.disabled = processing;
                this.elements.stopBtn.disabled = !processing;

                if (!processing) {
                    this.elements.currentPhase.textContent = 'In attesa';
                    this.elements.progressFill.style.width = '0%';
                    this.elements.progressText.textContent = 'Pronto per l\'elaborazione';
                }
            }

            updateProcessingStatus(data) {
                // Se data √® una stringa, mostrala semplicemente
                if (typeof data === 'string') {
                    this.elements.currentPhase.textContent = data;
                    return;
                }

                const {
                    phase,
                    current,
                    total,
                    file
                } = data;

                let phaseText = '';
                switch (phase) {
                    case 'extraction':
                        phaseText = 'Estrazione frame';
                        break;
                    case 'ai-analysis':
                        phaseText = 'Analisi AI';
                        break;
                    case 'banner-processing':
                        phaseText = 'Processamento Banner';
                        break;
                    default:
                        phaseText = phase || 'Elaborazione';
                }

                this.elements.currentPhase.textContent = phaseText;

                // Verifica che current e total siano definiti
                if (current !== undefined && total !== undefined) {
                    const progress = (current / total) * 100;
                    this.elements.progressFill.style.width = `${progress}%`;
                    this.elements.progressText.textContent =
                        `${phaseText}: ${current}/${total} - ${file || 'File sconosciuto'}`;
                }

                // Aggiungi log dettagliato se i valori sono definiti
                if (file && current !== undefined && total !== undefined) {
                    console.log(`${phaseText}: elaborazione ${file} (${current}/${total})`);
                }
            }

            onProcessingComplete(data) {
                this.setProcessingState(false);

                if (data.totalProcessed !== undefined) {
                    console.log(`Elaborazione completata! Processati ${data.totalProcessed} video`);
                }

                if (data.results && data.results.length !== undefined) {
                    console.log(`Risultati salvati in ${data.results.length} file`);
                }

                if (data.message) {
                    console.log(data.message);
                }

                // Aggiorna la lista video se necessario
                this.refreshVideoList();

                // Apri cartella OUTPUT se il checkbox √® selezionato
                const openOutputFolder = document.getElementById('open-output-folder');
                if (openOutputFolder && openOutputFolder.checked) {
                    if (window.electronAPI && window.electronAPI.openOutputFolder) {
                        window.electronAPI.openOutputFolder();
                    }
                }
            }

            onProcessingError(error) {
                this.setProcessingState(false);
                console.error('Errore durante l\'elaborazione:', error);
            }

            // Gestione errori dashboard
            handleDashboardError(errorData) {
                try {
                    // Protezione da spam di errori identici
                    const errorKey = `dashboard_${errorData.message}`;
                    const now = Date.now();
                    if (this.lastErrors && this.lastErrors[errorKey] && (now - this.lastErrors[errorKey]) < 1000) {
                        return; // Ignora errori duplicati entro 1 secondo
                    }

                    this.lastErrors = this.lastErrors || {};
                    this.lastErrors[errorKey] = now;

                    console.error('ERRORE DASHBOARD:', errorData.message);

                    // Mostra notifica prominente per errori critici
                    this.showErrorNotification('Errore Sistema', errorData.message);
                } catch (e) {
                    console.warn('Error in handleDashboardError:', e);
                }
            }

            // Gestione errori API specifici
            handleApiError(errorData) {
                try {
                    // Protezione da spam di errori identici
                    const errorKey = `api_${errorData.error}`;
                    const now = Date.now();
                    if (this.lastErrors && this.lastErrors[errorKey] && (now - this.lastErrors[errorKey]) < 1000) {
                        return; // Ignora errori duplicati entro 1 secondo
                    }

                    this.lastErrors = this.lastErrors || {};
                    this.lastErrors[errorKey] = now;

                    console.error('ERRORE API:', errorData.error);

                    // Mostra dettagli specifici per errori API
                    if (errorData.context) {
                        console.error('Contesto:', errorData.context);
                    }

                    this.showErrorNotification('Errore API', errorData.error);
                } catch (e) {
                    console.warn('Error in handleApiError:', e);
                }
            }

            // Gestione errori di elaborazione
            handleProcessingError(errorData) {
                try {
                    // Protezione da spam di errori identici
                    const errorKey = `processing_${errorData.error}`;
                    const now = Date.now();
                    if (this.lastErrors && this.lastErrors[errorKey] && (now - this.lastErrors[errorKey]) < 1000) {
                        return; // Ignora errori duplicati entro 1 secondo
                    }

                    this.lastErrors = this.lastErrors || {};
                    this.lastErrors[errorKey] = now;

                    console.error('ERRORE ELABORAZIONE:', errorData.error);

                    if (errorData.phase) {
                        console.error('Fase:', errorData.phase);
                    }

                    this.showErrorNotification('Errore Elaborazione', errorData.error);
                    this.updateProcessingStatus({
                        phase: 'error',
                        message: errorData.error
                    });
                } catch (e) {
                    console.warn('Error in handleProcessingError:', e);
                }
            }

            // Gestione errori analisi AI
            handleAiAnalysisError(errorData) {
                try {
                    // Protezione da spam di errori identici
                    const errorKey = `ai_${errorData.video}_${errorData.error}`;
                    const now = Date.now();
                    if (this.lastErrors && this.lastErrors[errorKey] && (now - this.lastErrors[errorKey]) < 2000) {
                        return; // Ignora errori duplicati entro 2 secondi
                    }

                    this.lastErrors = this.lastErrors || {};
                    this.lastErrors[errorKey] = now;

                    console.error(`ERRORE ANALISI AI [${errorData.video}]:`, errorData.error);

                    this.showErrorNotification('Errore Analisi AI',
                        `Errore nell'analisi del video "${errorData.video}": ${errorData.error}`);
                } catch (e) {
                    console.warn('Error in handleAiAnalysisError:', e);
                }
            }

            // NUOVO: Gestione successo applicazione metadati
            handleVideoMetadataApplied(data) {
                try {
                    console.log(`‚úÖ Metadati applicati con successo: ${data.title}`);
                    
                    // Aggiorna lo status di processamento
                    this.updateProcessingStatus({
                        phase: 'metadata-applied',
                        message: `Video completato: ${data.title}`,
                        success: true
                    });

                    // Mostra notifica di successo
                    this.showSuccessNotification('Metadati Applicati', `Video "${data.title}" completato con metadati`);
                    
                    // Log per debugging
                    console.log('Percorso originale:', data.originalPath);
                    console.log('Nuovo percorso:', data.newPath);
                    
                } catch (e) {
                    console.warn('Error in handleVideoMetadataApplied:', e);
                }
            }

            // NUOVO: Gestione errori applicazione metadati
            handleVideoMetadataError(data) {
                try {
                    console.error(`‚ùå Errore applicazione metadati: ${data.error}`);
                    
                    // Mostra notifica di avviso (non errore critico)
                    this.showWarningNotification('Metadati Non Applicati', 
                        `Video creato ma metadati non applicati: ${data.error}`);
                    
                    // Aggiorna status senza fermare il processo
                    this.updateProcessingStatus({
                        phase: 'metadata-warning',
                        message: `Video creato (metadati falliti): ${data.error}`,
                        warning: true
                    });
                    
                } catch (e) {
                    console.warn('Error in handleVideoMetadataError:', e);
                }
            }

            // Mostra notifica di errore prominente
            showErrorNotification(title, message) {
                try {
                    // Crea notifica in-app se non esiste gi√†
                    let errorContainer = document.getElementById('error-notifications');
                    if (!errorContainer) {
                        errorContainer = document.createElement('div');
                        errorContainer.id = 'error-notifications';
                        errorContainer.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            z-index: 10000;
                            max-width: 400px;
                        `;
                        document.body.appendChild(errorContainer);
                    }

                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        background: linear-gradient(135deg, #e74c3c, #c0392b);
                        color: white;
                        padding: 15px;
                        border-radius: 8px;
                        margin-bottom: 10px;
                        box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
                        border-left: 5px solid #fff;
                        animation: slideInRight 0.3s ease-out;
                    `;

                    notification.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div style="font-weight: bold; margin-bottom: 5px;">üö® ${title}</div>
                                <div style="font-size: 14px; line-height: 1.4;">${message}</div>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" 
                                    style="background: none; border: none; color: white; cursor: pointer; font-size: 18px; padding: 0; margin-left: 10px;">√ó</button>
                        </div>
                    `;

                    errorContainer.appendChild(notification);

                    // Auto-rimozione dopo 8 secondi
                    setTimeout(() => {
                        try {
                            if (notification.parentNode) {
                                notification.remove();
                            }
                        } catch (e) {
                            console.warn('Error removing notification:', e);
                        }
                    }, 8000);
                } catch (error) {
                    // Fallback estremo per errori di notifica
                    console.error('[NOTIFICATION ERROR]', title, message, error);
                }
            }

            // NUOVO: Mostra notifica di successo
            showSuccessNotification(title, message) {
                try {
                    let successContainer = document.getElementById('success-notifications');
                    if (!successContainer) {
                        successContainer = document.createElement('div');
                        successContainer.id = 'success-notifications';
                        successContainer.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            z-index: 10000;
                            max-width: 400px;
                        `;
                        document.body.appendChild(successContainer);
                    }

                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        background: linear-gradient(135deg, #27ae60, #2ecc71);
                        color: white;
                        padding: 15px;
                        border-radius: 8px;
                        margin-bottom: 10px;
                        box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
                        animation: slideInRight 0.3s ease-out;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    `;

                    notification.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div style="font-weight: bold; margin-bottom: 5px;">‚úÖ ${title}</div>
                                <div style="font-size: 14px; line-height: 1.4;">${message}</div>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" 
                                    style="background: none; border: none; color: white; cursor: pointer; font-size: 18px; padding: 0; margin-left: 10px;">√ó</button>
                        </div>
                    `;

                    successContainer.appendChild(notification);

                    // Auto-rimozione dopo 5 secondi
                    setTimeout(() => {
                        try {
                            if (notification.parentNode) {
                                notification.remove();
                            }
                        } catch (e) {
                            console.warn('Error removing success notification:', e);
                        }
                    }, 5000);
                } catch (error) {
                    console.error('[SUCCESS NOTIFICATION ERROR]', title, message, error);
                }
            }

            // NUOVO: Mostra notifica di avviso
            showWarningNotification(title, message) {
                try {
                    let warningContainer = document.getElementById('warning-notifications');
                    if (!warningContainer) {
                        warningContainer = document.createElement('div');
                        warningContainer.id = 'warning-notifications';
                        warningContainer.style.cssText = `
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            z-index: 10000;
                            max-width: 400px;
                        `;
                        document.body.appendChild(warningContainer);
                    }

                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        background: linear-gradient(135deg, #f39c12, #e67e22);
                        color: white;
                        padding: 15px;
                        border-radius: 8px;
                        margin-bottom: 10px;
                        box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
                        animation: slideInRight 0.3s ease-out;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    `;

                    notification.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                            <div>
                                <div style="font-weight: bold; margin-bottom: 5px;">‚ö†Ô∏è ${title}</div>
                                <div style="font-size: 14px; line-height: 1.4;">${message}</div>
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" 
                                    style="background: none; border: none; color: white; cursor: pointer; font-size: 18px; padding: 0; margin-left: 10px;">√ó</button>
                        </div>
                    `;

                    warningContainer.appendChild(notification);

                    // Auto-rimozione dopo 6 secondi
                    setTimeout(() => {
                        try {
                            if (notification.parentNode) {
                                notification.remove();
                            }
                        } catch (e) {
                            console.warn('Error removing warning notification:', e);
                        }
                    }, 6000);
                } catch (error) {
                    console.error('[WARNING NOTIFICATION ERROR]', title, message, error);
                }
            }

            async openApiManager() {
                try {
                    this.apiConfig = await window.electronAPI.loadApiConfig();
                    this.renderApiManager();
                    this.elements.apiModal.style.display = 'flex';
                } catch (error) {
                    console.error('Errore apertura gestione API:', error.message);
                }
            }

            closeApiManager() {
                this.elements.apiModal.style.display = 'none';
            }

            renderApiManager() {
                    const apis = Object.keys(this.apiConfig || {});

                    let html = `
                    <div style="margin-bottom: 20px;">
                        <h3>üîå API Configurate</h3>
                        <p>Gestisci le configurazioni API per l'analisi AI</p>
                        <button class="btn btn-primary" onclick="ui.showNewApiForm()" style="margin-top: 10px;">
                            ‚ûï Aggiungi Nuova API
                        </button>
                    </div>
                `;

                    if (apis.length === 0) {
                        html += `
                        <div style="text-align: center; padding: 40px; color: #999;">
                            <p>Nessuna API configurata. Inizia aggiungendo la tua prima API.</p>
                        </div>
                    `;
                    } else {
                        html += '<div class="api-cards-container">';

                        // Ordina le API per priorit√†
                        apis.sort((a, b) => (this.apiConfig[a].priority || 999) - (this.apiConfig[b].priority || 999));

                        apis.forEach((apiKey, index) => {
                                    const api = this.apiConfig[apiKey];
                                    const modelCount = Object.keys(api.models || {}).length;
                                    const enabled = api.enabled !== false;
                                    const priority = api.priority || index + 1;

                                    html += `
                            <div class="api-card" style="border: 2px solid ${enabled ? '#27ae60' : '#e74c3c'}; border-radius: 12px; padding: 20px; margin-bottom: 20px; background: ${enabled ? '#f8fff8' : '#fff8f8'};">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px;">
                                    <div style="flex: 1;">
                                        <h4 style="margin: 0; color: #2c3e50; font-size: 18px;">
                                            <span style="color: ${enabled ? '#27ae60' : '#e74c3c'};">${enabled ? '‚óè' : '‚óã'}</span>
                                            ${api.alias || apiKey}
                                        </h4>
                                        <p style="margin: 5px 0; color: #666; font-size: 14px; word-break: break-all; overflow-wrap: break-word;">
                                            ID: <code style="word-break: break-all; max-width: 200px; display: inline-block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${apiKey}">${apiKey}</code> ‚Ä¢ ${modelCount} modelli ‚Ä¢ Priorit√†: ${priority}
                                        </p>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn" style="padding: 8px 12px; background: #3498db; color: white; border-radius: 6px;" onclick="ui.selectApiSync('${apiKey}')">
                                            ‚úèÔ∏è Modifica
                                        </button>
                                        <button class="btn" style="padding: 8px 12px; background: ${enabled ? '#e67e22' : '#27ae60'}; color: white; border-radius: 6px;" onclick="ui.toggleApiStatus('${apiKey}')">
                                            ${enabled ? '‚è∏Ô∏è Disabilita' : '‚ñ∂Ô∏è Abilita'}
                                        </button>
                                        <button class="btn" style="padding: 8px 12px; background: #e74c3c; color: white; border-radius: 6px;" onclick="ui.confirmDeleteApi('${apiKey}')">
                                            üóëÔ∏è Elimina
                                        </button>
                                    </div>
                                </div>
                                
                                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #e0e0e0;">
                                    <div style="margin-bottom: 10px;">
                                        <strong style="color: #2c3e50;">Modelli Configurati:</strong>
                                    </div>
                                    ${modelCount > 0 ? 
                                        Object.entries(api.models).sort(([,a], [,b]) => (a.priority || 999) - (b.priority || 999)).map(([modelName, modelConfig]) => `
                                            <div style="display: inline-block; background: #e3f2fd; padding: 8px 12px; border-radius: 20px; margin: 4px; font-size: 13px; border: 1px solid #90caf9;">
                                                <strong>${modelName}</strong><br>
                                                <small style="color: #1976d2;">
                                                    Priorit√†: ${modelConfig.priority || 'N/A'} | 
                                                    RPM: ${modelConfig.limits?.RPM || 'N/A'} | 
                                                    RPD: ${modelConfig.limits?.RPD || 'N/A'}
                                                </small>
                                            </div>
                                        `).join('') : 
                                        '<div style="color: #666; font-style: italic;">Nessun modello configurato</div>'
                                    }
                                </div>
                            </div>
                        `;
                    });

                    html += '</div>';
                }

                // Sostituisce il contenuto se esiste l'elemento
                const contentElement = document.getElementById('api-content');
                if (contentElement) {
                    contentElement.innerHTML = html;
                }
            }

            // Metodi per la dashboard integrata
            async openApiManager() {
                this.elements.apiModal.style.display = 'flex';
                await this.loadApiConfig();
                await this.renderApiList();
                this.showWelcomeScreen();
            }

            closeApiManager() {
                this.elements.apiModal.style.display = 'none';
                this.hideAllForms();
            }

            async loadApiConfig() {
                try {
                    this.apiConfig = await window.electronAPI.loadApiConfig();
                } catch (error) {
                    console.error('Errore caricamento API config:', error);
                    this.apiConfig = {};
                }
            }

            async renderApiList() {
                const apiList = document.getElementById('api-list');
                
                // Carica le statistiche API aggiornate
                let apiStats = {};
                try {
                    apiStats = await window.electronAPI.getApiStats();
                } catch (error) {
                    console.error('Errore caricamento statistiche API:', error);
                }
                
                const apis = Object.keys(this.apiConfig || {});

                if (apis.length === 0) {
                    apiList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666;">
                            <p>Nessuna API configurata</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                apis.sort((a, b) => (this.apiConfig[a].priority || 999) - (this.apiConfig[b].priority || 999));

                apis.forEach(apiKey => {
                    const api = this.apiConfig[apiKey];
                    const stats = apiStats[apiKey] || {};
                    const enabled = api.enabled !== false;
                    const modelCount = Object.keys(api.models || {}).length;
                    
                    // Calcola totale richieste di oggi per questa API
                    let todayApiRequests = 0;
                    let maxRpdUsage = 0;
                    
                    for (const modelKey in stats.models || {}) {
                        const modelStats = stats.models[modelKey];
                        todayApiRequests += modelStats.todayRequests || 0;
                        maxRpdUsage = Math.max(maxRpdUsage, modelStats.rpdUsage || 0);
                    }

                    html += `
                        <div class="api-list-item ${enabled ? 'active' : 'disabled'}" onclick="ui.selectApiSync('${apiKey}')">
                            <div class="api-status-badge ${enabled ? '' : 'disabled'}"></div>
                            <div style="font-weight: 600; margin-bottom: 5px;">${api.alias || apiKey}</div>
                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                                ID: ${apiKey}<br>
                                ${modelCount} modelli ‚Ä¢ Priorit√†: ${api.priority || 'N/A'}
                            </div>
                            <div class="api-stats">
                                <div style="font-size: 11px; color: #28a745; font-weight: 500;">
                                    üìä Oggi: ${todayApiRequests} richieste
                                </div>
                                ${maxRpdUsage > 0 ? `
                                <div class="rpd-usage-bar">
                                    <div class="rpd-usage-fill" style="width: ${Math.min(maxRpdUsage, 100)}%; background-color: ${maxRpdUsage > 80 ? '#dc3545' : maxRpdUsage > 60 ? '#ffc107' : '#28a745'}"></div>
                                </div>
                                <div style="font-size: 10px; color: #666;">
                                    Utilizzo massimo RPD: ${maxRpdUsage}%
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });

                apiList.innerHTML = html;
            }

            showWelcomeScreen() {
                this.hideAllForms();
                document.getElementById('api-welcome').style.display = 'block';
            }

            hideAllForms() {
                document.getElementById('api-welcome').style.display = 'none';
                document.getElementById('new-api-form').classList.remove('active');
                document.getElementById('edit-api-form').classList.remove('active');
            }

            showNewApiForm() {
                this.hideAllForms();
                document.getElementById('new-api-form').classList.add('active');

                // Reset form
                document.getElementById('new-api-id').value = '';
                document.getElementById('new-api-alias').value = '';
                document.getElementById('new-api-priority').value = '1';
                document.getElementById('new-api-enabled').checked = true;
            }

            async saveNewApi() {
                const id = document.getElementById('new-api-id').value.trim();
                const alias = document.getElementById('new-api-alias').value.trim();
                const priority = parseInt(document.getElementById('new-api-priority').value);
                const enabled = document.getElementById('new-api-enabled').checked;

                if (!id || !alias) {
                    alert('Compila tutti i campi obbligatori');
                    return;
                }

                if (this.apiConfig[id]) {
                    alert('Un\'API con questo ID esiste gi√†');
                    return;
                }

                this.apiConfig[id] = {
                    alias: alias,
                    priority: priority,
                    enabled: enabled,
                    models: {}
                };

                await this.saveApiConfig();
                await this.renderApiList();
                this.selectApi(id);
                console.log(`API ${alias} creata con successo`);
            }

            cancelNewApi() {
                this.showWelcomeScreen();
            }

            async selectApi(apiKey) {
                this.currentApiKey = apiKey;
                this.hideAllForms();
                await this.loadApiForm(apiKey);
                document.getElementById('edit-api-form').classList.add('active');
            }

            // Wrapper per onclick
            selectApiSync(apiKey) {
                this.selectApi(apiKey).catch(error => {
                    console.error('Errore selezione API:', error);
                });
            }

            async loadApiForm(apiKey) {
                const api = this.apiConfig[apiKey];

                document.getElementById('edit-api-title').textContent = `‚úèÔ∏è Modifica ${api.alias}`;
                document.getElementById('edit-api-id').value = apiKey;
                document.getElementById('edit-api-alias').value = api.alias || '';
                document.getElementById('edit-api-priority').value = api.priority || 1;
                document.getElementById('edit-api-enabled').checked = api.enabled !== false;

                await this.renderModelsList(apiKey);
            }

            async renderModelsList(apiKey) {
                const modelsList = document.getElementById('models-list');
                const models = this.apiConfig[apiKey].models || {};
                const modelKeys = Object.keys(models);

                // Carica le statistiche API aggiornate
                let apiStats = {};
                try {
                    apiStats = await window.electronAPI.getApiStats();
                } catch (error) {
                    console.error('Errore caricamento statistiche modelli:', error);
                }

                if (modelKeys.length === 0) {
                    modelsList.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #666; border: 2px dashed #e0e0e0; border-radius: 8px;">
                            <p>Nessun modello configurato</p>
                            <p style="font-size: 12px;">Usa il form qui sotto per aggiungere il primo modello</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                // Ordina i modelli per priorit√†
                modelKeys.sort((a, b) => {
                    const priorityA = models[a].priority || 999;
                    const priorityB = models[b].priority || 999;
                    return priorityA - priorityB;
                });

                modelKeys.forEach(modelKey => {
                    const model = models[modelKey];
                    const limits = model.limits || {};
                    const priority = model.priority || 'N/A';
                    
                    // Ottieni le statistiche per questo modello specifico
                    const modelStats = apiStats[apiKey]?.models?.[modelKey] || {};
                    const todayRequests = modelStats.todayRequests || 0;
                    const totalRequests = modelStats.totalRequests || 0;
                    const rpdUsage = modelStats.rpdUsage || 0;

                    html += `
                        <div class="model-item" style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                            <div class="model-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div class="model-name" style="flex: 1;">
                                    <input type="text" value="${modelKey}" 
                                           style="border: none; background: transparent; font-weight: bold; font-size: 16px; width: 200px; color: #2c3e50;" 
                                           onchange="ui.editModelName('${apiKey}', '${modelKey}', this.value)" />
                                    <div style="color: #666; font-size: 12px; margin-top: 5px;">
                                        Priorit√†: 
                                        <select onchange="ui.editModelPriority('${apiKey}', '${modelKey}', this.value)" 
                                                style="border: 1px solid #ddd; border-radius: 4px; padding: 2px 6px; background: white;">
                                            ${Array.from({length: 10}, (_, i) => {
                                                const val = i + 1;
                                                return `<option value="${val}" ${priority == val ? 'selected' : ''}>${val}</option>`;
                                            }).join('')}
                                        </select>
                                    </div>
                                </div>
                                <div class="model-actions" style="display: flex; gap: 8px;">
                                    <button class="btn-small btn-edit" 
                                            style="background: #3498db; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer;"
                                            onclick="ui.editModel('${apiKey}', '${modelKey}')" 
                                            title="Modifica">‚úèÔ∏è</button>
                                    <button class="btn-small btn-delete" 
                                            style="background: #e74c3c; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer;"
                                            onclick="ui.deleteModel('${apiKey}', '${modelKey}')">üóëÔ∏è</button>
                                </div>
                            </div>
                            
                            <!-- Statistiche utilizzo modello -->
                            <div class="model-stats" style="background: white; border-radius: 6px; padding: 10px; margin-bottom: 15px; border-left: 4px solid ${rpdUsage > 80 ? '#dc3545' : rpdUsage > 60 ? '#ffc107' : '#28a745'};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="font-size: 13px; font-weight: 500; color: #2c3e50;">
                                        üìä Statistiche utilizzo (Pacifico)
                                    </div>
                                    <div style="font-size: 11px; color: #666;">
                                        Totale: ${totalRequests} richieste
                                    </div>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-size: 12px; color: #28a745; font-weight: 500;">
                                        üü¢ Oggi: ${todayRequests} richieste
                                    </span>
                                    <span style="font-size: 12px; color: ${rpdUsage > 80 ? '#dc3545' : rpdUsage > 60 ? '#ffc107' : '#28a745'}; font-weight: 500;">
                                        ${rpdUsage}% RPD utilizzato
                                    </span>
                                </div>
                                ${rpdUsage > 0 ? `
                                <div class="rpd-usage-bar" style="width: 100%; height: 4px; background-color: #e9ecef; border-radius: 2px; overflow: hidden;">
                                    <div class="rpd-usage-fill" style="height: 100%; width: ${Math.min(rpdUsage, 100)}%; background-color: ${rpdUsage > 80 ? '#dc3545' : rpdUsage > 60 ? '#ffc107' : '#28a745'}; border-radius: 2px; transition: width 0.3s ease;"></div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="limits-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                                <div class="limit-item" style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">RPM</div>
                                    <input type="number" value="${limits.RPM || 100}" 
                                           style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: center;"
                                           onchange="ui.editModelLimit('${apiKey}', '${modelKey}', 'RPM', this.value)" />
                                </div>
                                <div class="limit-item" style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">RPD</div>
                                    <input type="number" value="${limits.RPD || 1000}" 
                                           style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: center;"
                                           onchange="ui.editModelLimit('${apiKey}', '${modelKey}', 'RPD', this.value)" />
                                    <div style="font-size: 10px; color: #666; margin-top: 2px;">
                                        Limite: ${limits.RPD || 1000}
                                    </div>
                                </div>
                                <div class="limit-item" style="text-align: center; padding: 10px; background: white; border-radius: 6px;">
                                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">TPM</div>
                                    <input type="number" value="${limits.TPM || 50000}" 
                                           style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: center;"
                                           onchange="ui.editModelLimit('${apiKey}', '${modelKey}', 'TPM', this.value)" />
                                </div>
                            </div>
                        </div>
                    `;
                });

                modelsList.innerHTML = html;
            }

            async addNewModel() {
                if (!this.currentApiKey) return;

                const name = document.getElementById('new-model-name').value.trim();
                const priority = parseInt(document.getElementById('new-model-priority').value) || 1;
                const rpm = parseInt(document.getElementById('new-model-rpm').value) || 100;
                const rpd = parseInt(document.getElementById('new-model-rpd').value) || 1000;
                const tpm = parseInt(document.getElementById('new-model-tpm').value) || 50000;

                if (!name) {
                    alert('Inserisci il nome del modello');
                    return;
                }

                if (this.apiConfig[this.currentApiKey].models[name]) {
                    alert('Un modello con questo nome esiste gi√†');
                    return;
                }

                // Controlla se esiste gi√† un modello con la stessa priorit√†
                const existingModelWithPriority = Object.entries(this.apiConfig[this.currentApiKey].models || {})
                    .find(([, model]) => model.priority === priority);

                if (existingModelWithPriority) {
                    alert(`
            Errore: Esiste gi√† un modello "${existingModelWithPriority[0]}"
            con priorit√† $ {
                priority
            }.\nCambia la priorit√† per il nuovo modello.
            `);
                    return;
                }

                this.apiConfig[this.currentApiKey].models[name] = {
                    priority: priority,
                    limits: {
                        RPM: rpm,
                        RPD: rpd,
                        TPM: tpm
                    },
                    requests: {}
                };

                // Auto-save
                await this.saveApiConfig();

                // Reset form
                document.getElementById('new-model-name').value = '';
                document.getElementById('new-model-priority').value = '1';
                document.getElementById('new-model-rpm').value = '100';
                document.getElementById('new-model-rpd').value = '1000';
                document.getElementById('new-model-tpm').value = '50000';

                await this.renderModelsList(this.currentApiKey);
                await this.renderApiList(); // Aggiorna anche la lista
                console.log(`Modello ${name} aggiunto a ${this.apiConfig[this.currentApiKey].alias} con priorit√† ${priority}`);
            }

            async deleteModel(apiKey, modelKey) {
                if (confirm(`Eliminare il modello ${modelKey}?`)) {
                    delete this.apiConfig[apiKey].models[modelKey];
                    await this.saveApiConfig();
                    await this.renderModelsList(apiKey);
                    await this.renderApiList();
                    console.log(`Modello ${modelKey} eliminato`);
                }
            }

            async saveApiChanges() {
                if (!this.currentApiKey) return;

                const alias = document.getElementById('edit-api-alias').value.trim();
                const priority = parseInt(document.getElementById('edit-api-priority').value);
                const enabled = document.getElementById('edit-api-enabled').checked;

                if (!alias) {
                    alert('Il nome descrittivo √® obbligatorio');
                    return;
                }

                this.apiConfig[this.currentApiKey].alias = alias;
                this.apiConfig[this.currentApiKey].priority = priority;
                this.apiConfig[this.currentApiKey].enabled = enabled;

                await this.saveApiConfig();
                await this.renderApiList();
                console.log(`API ${alias} aggiornata con successo`);
            }

            cancelEdit() {
                this.showWelcomeScreen();
            }

            async deleteCurrentApi() {
                if (!this.currentApiKey) return;

                const apiName = this.apiConfig[this.currentApiKey].alias;
                if (confirm(`Eliminare l'API ${apiName}?\n\nQuesta azione eliminer√† anche tutti i modelli configurati.`)) {
                    delete this.apiConfig[this.currentApiKey];
                    await this.saveApiConfig();
                    await this.renderApiList();
                    this.showWelcomeScreen();
                    console.log(`API ${apiName} eliminata`);
                }
            }

        async saveApiConfig() {
            try {
                await window.electronAPI.saveApiConfig(this.apiConfig);
            } catch (error) {
                console.error('Errore salvataggio API config:', error);
                this.addLog('Errore nel salvataggio configurazione API', 'error');
            }
        }

        // Auto-save per le modifiche API
        async autoSaveApiChanges() {
            if (!this.currentApiKey) return;

            const alias = document.getElementById('edit-api-alias').value.trim();
            const priority = parseInt(document.getElementById('edit-api-priority').value);
            const enabled = document.getElementById('edit-api-enabled').checked;

            if (!alias) return;

            this.apiConfig[this.currentApiKey].alias = alias;
            this.apiConfig[this.currentApiKey].priority = priority;
            this.apiConfig[this.currentApiKey].enabled = enabled;

            await this.saveApiConfig();
            await this.renderApiList();
        }

        // Modifica nome modello
        async editModelName(apiKey, oldName, newName) {
            if (!newName.trim() || oldName === newName) return;

            if (this.apiConfig[apiKey].models[newName]) {
                alert('Un modello con questo nome esiste gi√†');
                await this.renderModelsList(apiKey);
                return;
            }

            // Sposta il modello con il nuovo nome
            const modelData = this.apiConfig[apiKey].models[oldName];
            this.apiConfig[apiKey].models[newName] = modelData;
            delete this.apiConfig[apiKey].models[oldName];

            await this.saveApiConfig();
            await this.renderModelsList(apiKey);
            await this.renderApiList();
            console.log(`Modello rinominato da "${oldName}" a "${newName}"`);
        }

        // Modifica priorit√† modello
        async editModelPriority(apiKey, modelName, newPriority) {
            const priority = parseInt(newPriority);
            const currentPriority = this.apiConfig[apiKey].models[modelName].priority;

            if (priority === currentPriority) return;

            // Controlla se esiste gi√† un modello con la stessa priorit√†
            const existingModelWithPriority = Object.entries(this.apiConfig[apiKey].models || {})
                .find(([name, model]) => name !== modelName && model.priority === priority);

            if (existingModelWithPriority) {
                alert(`Errore: Il modello "${existingModelWithPriority[0]}" ha gi√† priorit√† ${priority}.\nCambia prima la priorit√† di quel modello.`);
                await this.renderModelsList(apiKey);
                return;
            }

            this.apiConfig[apiKey].models[modelName].priority = priority;
            await this.saveApiConfig();
            await this.renderModelsList(apiKey);
            console.log(`Priorit√† modello "${modelName}" cambiata a ${priority}`);
        }

        // Modifica limiti modello
        async editModelLimit(apiKey, modelName, limitType, newValue) {
            const value = parseInt(newValue);
            if (value <= 0) return;

            this.apiConfig[apiKey].models[modelName].limits[limitType] = value;
            await this.saveApiConfig();
            console.log(`${limitType} modello "${modelName}" aggiornato a ${value}`);
        }

        // Modifica modello (modal dettagliato)
        editModel(apiKey, modelName) {
            const model = this.apiConfig[apiKey].models[modelName];
            alert(`Modifica dettagliata del modello "${modelName}":\n\nPriorit√†: ${model.priority}\nRPM: ${model.limits.RPM}\nRPD: ${model.limits.RPD}\nTPM: ${model.limits.TPM}\n\nUsa i campi diretti per modificare i valori.`);
        }

        // Aggiungi nuovo modello
        async addNewModel() {
            if (!this.currentApiKey) return;

            const name = document.getElementById('new-model-name').value.trim();
            const priority = parseInt(document.getElementById('new-model-priority').value) || 1;
            const rpm = parseInt(document.getElementById('new-model-rpm').value) || 100;
            const rpd = parseInt(document.getElementById('new-model-rpd').value) || 1000;
            const tpm = parseInt(document.getElementById('new-model-tpm').value) || 50000;

            if (!name) {
                alert('Inserisci il nome del modello');
                return;
            }

            if (this.apiConfig[this.currentApiKey].models[name]) {
                alert('Un modello con questo nome esiste gi√†');
                return;
            }

            // Controlla se esiste gi√† un modello con la stessa priorit√†
            const existingModelWithPriority = Object.entries(this.apiConfig[this.currentApiKey].models || {})
                .find(([, model]) => model.priority === priority);

            if (existingModelWithPriority) {
                alert(`Errore: Esiste gi√† un modello "${existingModelWithPriority[0]}" con priorit√† ${priority}.\nCambia la priorit√† per il nuovo modello.`);
                return;
            }

            this.apiConfig[this.currentApiKey].models[name] = {
                priority: priority,
                limits: {
                    RPM: rpm,
                    RPD: rpd,
                    TPM: tpm
                },
                requests: {}
            };

            // Reset form
            document.getElementById('new-model-name').value = '';
            document.getElementById('new-model-priority').value = '1';
            document.getElementById('new-model-rpm').value = '100';
            document.getElementById('new-model-rpd').value = '1000';
            document.getElementById('new-model-tpm').value = '50000';

            await this.saveApiConfig();
            await this.renderModelsList(this.currentApiKey);
            await this.renderApiList();
            console.log(`Modello "${name}" aggiunto con successo`);
        }

        // Elimina modello
        async deleteModel(apiKey, modelName) {
            if (confirm(`Eliminare il modello "${modelName}"?\n\nQuesta azione non pu√≤ essere annullata.`)) {
                delete this.apiConfig[apiKey].models[modelName];
                await this.saveApiConfig();
                await this.renderModelsList(apiKey);
                await this.renderApiList();
                console.log(`Modello "${modelName}" eliminato`);
            }
        }

        // Toggle stato API
        async toggleApiStatus(apiKey) {
            if (this.apiConfig[apiKey]) {
                this.apiConfig[apiKey].enabled = !this.apiConfig[apiKey].enabled;
                await this.saveApiConfig();
                this.renderApiManager();
                const status = this.apiConfig[apiKey].enabled ? 'abilitata' : 'disabilitata';
                this.addLog(`API "${this.apiConfig[apiKey].alias}" ${status}`, 'info');
            }
        }

        // Conferma eliminazione API
        async confirmDeleteApi(apiKey) {
            const api = this.apiConfig[apiKey];
            const modelCount = Object.keys(api.models || {}).length;
            
            if (confirm(`Eliminare l'API "${api.alias}"?\n\nQuesta azione eliminer√† anche i ${modelCount} modelli configurati e non pu√≤ essere annullata.`)) {
                delete this.apiConfig[apiKey];
                await this.saveApiConfig();
                this.renderApiManager();
                this.addLog(`API "${api.alias}" eliminata`, 'info');
            }
        }
        }

        // Inizializza l'interfaccia
        const ui = new ContentCreatorUI();

        // Aggiorna periodicamente la lista video
        setInterval(() => {
            if (!ui.isProcessing) {
                ui.refreshVideoList();
            }
        }, 5000);
    </script>
</body>

</html>